<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>[x-cloak]{display:none!important} body{background:#f0f9ff; color:#334155;}</style>
</head>
<body x-data="app()">
    <!-- å¯¼èˆª -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <span class="text-2xl font-bold text-blue-600 tracking-wider">ğŸ³ è“é²¸å°ç«™</span>
            <div>
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold hover:bg-blue-50 px-4 py-2 rounded-lg transition">ç™»å½• / æ³¨å†Œ</button>
                </template>
                <template x-if="user">
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">
                            Hi, <span class="font-bold text-blue-600" x-text="user.username"></span>
                        </span>
                        <button @click="logout" class="text-sm text-gray-400 hover:text-red-500">é€€å‡º</button>
                    </div>
                </template>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“ -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- åˆ†ç±» Tab -->
        <div class="flex gap-2 overflow-x-auto pb-4 mb-4">
            <button @click="filterCat(null)" :class="!currentCat ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-blue-50'" class="px-4 py-1.5 rounded-full text-sm font-medium shadow-sm transition shrink-0">å…¨éƒ¨</button>
            <template x-for="cat in categories" :key="cat.id">
                <button @click="filterCat(cat.id)" :class="currentCat===cat.id ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-blue-50'" class="px-4 py-1.5 rounded-full text-sm font-medium shadow-sm transition shrink-0" x-text="cat.name"></button>
            </template>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div class="space-y-6">
            <template x-for="item in filteredResources" :key="item.id">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-50 hover:shadow-md transition">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800" x-text="item.title"></h3>
                        <span class="text-xs px-2 py-1 bg-gray-100 rounded text-gray-500" x-text="item.category_name || 'æœªåˆ†ç±»'"></span>
                    </div>
                    
                    <!-- å†…å®¹å—æ¸²æŸ“ -->
                    <div class="space-y-4 text-sm text-gray-700">
                        <template x-for="(block, idx) in item.content" :key="idx">
                            <div>
                                <!-- æ–‡æœ¬å— -->
                                <template x-if="block.type === 'text'">
                                    <p class="whitespace-pre-wrap" x-text="block.value"></p>
                                </template>
                                
                                <!-- å›¾ç‰‡å— -->
                                <template x-if="block.type === 'image'">
                                    <div class="relative group">
                                        <template x-if="block.isLockedMask">
                                            <div class="w-full h-32 bg-gray-100 flex items-center justify-center rounded-lg border-2 border-dashed border-gray-300">
                                                <button @click="unlock(item.id, idx)" class="text-blue-500 font-bold hover:underline">ğŸ”’ å›¾ç‰‡å—é™ (ç‚¹å‡»æ¶ˆè€—æ¬¡æ•°è§£é”)</button>
                                            </div>
                                        </template>
                                        <template x-if="!block.isLockedMask">
                                            <img :src="block.value" class="rounded-lg max-h-64 object-cover">
                                        </template>
                                    </div>
                                </template>

                                <!-- é“¾æ¥å— -->
                                <template x-if="block.type === 'link'">
                                    <div class="p-3 bg-blue-50 rounded-lg flex items-center gap-2">
                                        <span class="text-blue-400">ğŸ”—</span>
                                        <template x-if="block.isLockedMask">
                                            <button @click="unlock(item.id, idx)" class="text-blue-600 font-bold hover:underline">å—é™é“¾æ¥ (ç‚¹å‡»æ¶ˆè€—æ¬¡æ•°æŸ¥çœ‹)</button>
                                        </template>
                                        <template x-if="!block.isLockedMask">
                                            <a :href="block.value" target="_blank" class="text-blue-600 hover:underline break-all" x-text="block.value"></a>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            <div x-show="filteredResources.length === 0" class="text-center text-gray-400 py-10">è¿™é‡Œè¿˜æ˜¯ä¸€ç‰‡è“è‰²çš„æµ·æ´‹...</div>
        </div>
    </main>

    <!-- æ¨¡æ€æ¡†: ç™»å½•/æ³¨å†Œ/é‡ç½® -->
    <div x-show="modalMode" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-xl relative">
            <button @click="modalMode = null" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500">&times;</button>
            
            <!-- ç™»å½•è¡¨å• -->
            <div x-show="modalMode === 'login'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">æ¬¢è¿å›æ¥</h2>
                <div class="space-y-4">
                    <input type="text" x-model="form.loginId" placeholder="QQé‚®ç®± / ç”¨æˆ·å" class="w-full p-3 bg-blue-50 rounded-lg outline-none focus:ring-2 focus:ring-blue-300">
                    <input type="password" x-model="form.password" placeholder="å¯†ç " class="w-full p-3 bg-blue-50 rounded-lg outline-none focus:ring-2 focus:ring-blue-300">
                    <button @click="doLogin" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">ç™»å½•</button>
                    <div class="flex justify-between text-xs text-gray-500">
                        <button @click="modalMode = 'register'" class="hover:text-blue-600">æ³¨å†Œæ–°è´¦å·</button>
                        <button @click="modalMode = 'reset'" class="hover:text-blue-600">å¿˜è®°å¯†ç ?</button>
                    </div>
                </div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div x-show="modalMode === 'register'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">åŠ å…¥æˆ‘ä»¬</h2>
                <div class="space-y-4">
                    <input type="email" x-model="form.email" placeholder="QQé‚®ç®±" class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <div class="flex gap-2">
                        <input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                        <button @click="sendCode('register')" :disabled="timer>0" class="w-24 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold" x-text="timer>0?timer+'s':'å‘é€'"></button>
                    </div>
                    <input type="text" x-model="form.username" placeholder="è®¾ç½®ç”¨æˆ·å" class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <input type="password" x-model="form.password" placeholder="è®¾ç½®å¯†ç " class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <button @click="doRegister" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">æ³¨å†Œ</button>
                    <div class="text-center text-xs text-gray-500">
                        <button @click="modalMode = 'login'" class="hover:text-blue-600">å·²æœ‰è´¦å·? å»ç™»å½•</button>
                    </div>
                </div>
            </div>

            <!-- é‡ç½®å¯†ç  -->
            <div x-show="modalMode === 'reset'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">é‡ç½®å¯†ç </h2>
                <div class="space-y-4">
                    <input type="email" x-model="form.email" placeholder="æ³¨å†Œæ—¶çš„QQé‚®ç®±" class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <div class="flex gap-2">
                        <input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                        <button @click="sendCode('reset')" :disabled="timer>0" class="w-24 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold" x-text="timer>0?timer+'s':'å‘é€'"></button>
                    </div>
                    <input type="password" x-model="form.newPassword" placeholder="æ–°å¯†ç " class="w-full p-3 bg-blue-50 rounded-lg outline-none">
                    <button @click="doReset" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">é‡ç½®å¹¶ç™»å½•</button>
                    <div class="text-center text-xs text-gray-500">
                        <button @click="modalMode = 'login'" class="hover:text-blue-600">æƒ³èµ·æ¥äº†? å»ç™»å½•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                token: localStorage.getItem('token') || '',
                categories: [], resources: [], currentCat: null,
                modalMode: null, // 'login', 'register', 'reset'
                form: { loginId: '', email: '', username: '', password: '', newPassword: '', code: '' },
                timer: 0,

                get filteredResources() {
                    if(!this.currentCat) return this.resources;
                    return this.resources.filter(r => r.category_id === this.currentCat);
                },

                async init() {
                    const res = await fetch('/api/public/home');
                    const data = await res.json();
                    this.categories = data.categories;
                    this.resources = data.resources;
                },

                openModal(mode) { this.modalMode = mode; this.form = {loginId:'', email:'', username:'', password:'', newPassword:'', code:''}; },

                async sendCode(type) {
                    if(!this.form.email) return alert('è¯·è¾“å…¥é‚®ç®±');
                    const res = await fetch('/api/auth/send-code', { method:'POST', body:JSON.stringify({email:this.form.email, type})});
                    if(res.ok) { alert('å·²å‘é€'); this.timer=60; setInterval(()=>this.timer>0&&this.timer--,1000); }
                    else alert((await res.json()).error);
                },

                async doRegister() {
                    const res = await fetch('/api/auth/register', { method:'POST', body:JSON.stringify(this.form)});
                    const data = await res.json();
                    if(res.ok) this.loginSuccess(data); else alert(data.error);
                },

                async doLogin() {
                    const res = await fetch('/api/auth/login', { method:'POST', body:JSON.stringify({...this.form, isAdmin:false})});
                    const data = await res.json();
                    if(res.ok) this.loginSuccess(data); else alert(data.error);
                },

                async doReset() {
                    const res = await fetch('/api/auth/reset-password', { method:'POST', body:JSON.stringify({email:this.form.email, code:this.form.code, newPassword:this.form.newPassword})});
                    if(res.ok) { alert('å¯†ç é‡ç½®æˆåŠŸ'); this.modalMode='login'; } else alert((await res.json()).error);
                },

                loginSuccess(data) {
                    this.user = data.user; this.token = data.token;
                    localStorage.setItem('user', JSON.stringify(data.user)); localStorage.setItem('token', data.token);
                    this.modalMode = null;
                },
                logout() { localStorage.clear(); location.reload(); },

                async unlock(resourceId, blockIndex) {
                    if(!this.user) return this.modalMode = 'login';
                    if(!confirm('ç¡®å®šè¦æ¶ˆè€—ä¸€æ¬¡æœºä¼šæŸ¥çœ‹æ­¤å†…å®¹å—ï¼Ÿ')) return;
                    
                    const res = await fetch('/api/resource/unlock', {
                        method: 'POST',
                        headers: {'Authorization': `Bearer ${this.token}`},
                        body: JSON.stringify({ resourceId, blockIndex })
                    });
                    const data = await res.json();
                    if(res.ok) {
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        const r = this.resources.find(i => i.id === resourceId);
                        if(r) r.content[blockIndex] = { ...r.content[blockIndex], value: data.realValue, isLockedMask: false };
                        alert(`è§£é”æˆåŠŸï¼ä»Šæ—¥å‰©ä½™æŸ¥çœ‹æ¬¡æ•°: ${data.remaining}`);
                    } else {
                        alert(data.error);
                    }
                },
                
                filterCat(id) { this.currentCat = id; }
            }
        }
    </script>
</body>
</html>
