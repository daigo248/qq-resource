<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¼•å…¥ Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    
    <script>
        // === é…ç½®åŒºåŸŸ (è¯·å¡«å…¥ä½ çš„ Supabase ä¿¡æ¯) ===
        const SUPABASE_URL = 'https://toiggxduohuapmfnszcu.supabase.co'; // ä½ çš„ Project URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvaWdneGR1b2h1YXBtZm5zemN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NzU5MDksImV4cCI6MjA4MTI1MTkwOX0.tSTWbyOcoKD9bx8-NjwG_KCktMcGlQZbbrGAP_0hXng'; // ä½ çš„ anon public key
        // ===========================================

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // PCç«¯æ£€æµ‹
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobile) document.documentElement.classList.add('is-pc');
    </script>
    
    <style>
        [x-cloak] { display: none !important; } 
        body { background: #f0f9ff; color: #334155; font-family: sans-serif; }
        #pc-block { display: none; }
        .is-pc body > nav, .is-pc body > main, .is-pc body > footer { display: none; }
        .is-pc #pc-block { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f9ff; z-index: 9999; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body x-data="app()" @scroll.window="handleScroll">

    <div id="pc-block">
        <div class="text-6xl mb-4">ğŸš«</div>
        <h1 class="text-xl font-bold">ä»…æ”¯æŒç§»åŠ¨ç«¯è®¿é—®</h1>
    </div>

    <!-- å¯¼èˆª -->
    <nav class="bg-white/95 backdrop-blur shadow-sm sticky top-0 z-40 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-14 flex justify-between items-center">
            <a href="/" class="text-xl font-bold text-blue-600 tracking-wider flex items-center gap-2"><span>ğŸ³</span> è“é²¸å°ç«™</a>
            <div>
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold px-3 py-1.5 rounded-lg border border-blue-100 text-sm hover:bg-blue-50">ç™»å½•/æ³¨å†Œ</button>
                </template>
                <template x-if="user">
                    <button @click="showUserCenter" class="flex items-center gap-2 px-2 py-1 rounded-full border border-transparent hover:border-blue-100 transition relative">
                        <div class="w-7 h-7 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs" x-text="profile?.username?.[0].toUpperCase() || 'U'"></div>
                        <div class="text-xs text-blue-500 font-medium">ğŸ”‘ <span x-text="profile?.keys_count || 0"></span></div>
                    </button>
                </template>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-4">
        <!-- æœç´¢ä¸æ’åº -->
        <div class="flex gap-2 mb-4">
            <div class="relative flex-1">
                <input type="text" x-model="searchQ" @keyup.enter="doSearch(true)" placeholder="ğŸ” æœæ ‡é¢˜/æ—¥æœŸ..." class="w-full pl-3 pr-10 py-2.5 rounded-xl border border-blue-100 text-sm outline-none focus:ring-2 focus:ring-blue-300 shadow-sm bg-white">
                <button @click="doSearch(true)" class="absolute right-1 top-1 bottom-1 px-3 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold">æœç´¢</button>
            </div>
            <select x-model="sortType" @change="doSearch(true)" class="px-2 rounded-xl border border-blue-100 text-xs outline-none bg-white text-gray-600 shadow-sm">
                <option value="date-desc">ğŸ“… æœ€æ–°</option>
                <option value="date-asc">ğŸ“… æœ€æ—§</option>
            </select>
        </div>

        <!-- åˆ†ç±»/æ ‡ç­¾å¯¼èˆª -->
        <div class="grid grid-cols-12 gap-3 mb-6 relative z-30">
            <div class="col-span-4 relative" @click.away="showCatMenu = false">
                <button @click="showCatMenu = !showCatMenu" class="w-full h-12 rounded-xl bg-white border border-blue-200 text-blue-600 font-bold text-sm shadow-sm flex items-center justify-between px-3">
                    <span class="truncate" x-text="currentCat ? currentCat.name : 'ğŸ“‚ å…¨éƒ¨'"></span>
                    <span class="text-xs">â–¼</span>
                </button>
                <div x-show="showCatMenu" x-cloak x-transition class="absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-xl border border-blue-100 overflow-hidden py-1">
                    <button @click="filterCat(null)" class="w-full text-left px-4 py-3 text-sm hover:bg-blue-50">ğŸ“‚ å…¨éƒ¨</button>
                    <template x-for="c in categories" :key="c.id">
                        <button @click="filterCat(c)" class="w-full text-left px-4 py-3 text-sm hover:bg-blue-50" x-text="c.name"></button>
                    </template>
                </div>
            </div>
            <button @click="loadTags('ç•ªç»„')" class="col-span-4 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 text-white font-bold text-sm shadow-md">ğŸ“º ç•ªç»„</button>
            <button @click="loadTags('è‰ºäºº')" class="col-span-4 h-12 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 text-white font-bold text-sm shadow-md">ğŸ¤ è‰ºäºº</button>
        </div>

        <!-- æ ‡ç­¾å¢™ -->
        <div x-show="viewMode === 'tags'" x-cloak class="mb-6">
            <div class="flex justify-between items-center mb-3 px-1"><span class="text-xs font-bold text-gray-500" x-text="currentTagType + ' ç´¢å¼•'"></span><button @click="resetView" class="text-xs text-blue-500">âœ• å…³é—­</button></div>
            <div class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                <template x-for="t in tags" :key="t.id">
                    <div @click="filterByTag(t)" class="bg-white rounded-xl p-2 shadow-sm border border-gray-100 text-center cursor-pointer hover:border-blue-400">
                        <img :src="t.image_url || 'https://via.placeholder.com/100?text=No+Img'" loading="lazy" class="aspect-square w-full rounded-lg object-cover mb-1 bg-gray-50">
                        <div class="text-xs font-bold truncate text-gray-700" x-text="t.name"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- åˆ—è¡¨ -->
        <div x-show="viewMode === 'list'" class="space-y-4 min-h-[300px]">
            <template x-for="item in resources" :key="item.id">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-blue-50 hover:shadow-lg transition cursor-pointer" @click="openDetail(item)">
                    <div class="flex flex-wrap gap-1.5 mb-2.5">
                        <span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-md font-bold" x-text="getCatName(item.category_id)"></span>
                        <template x-for="rt in item.resource_tags">
                            <span class="text-[10px] px-2 py-0.5 rounded-md text-white font-medium shadow-sm" :class="rt.tags.type==='ç•ªç»„'?'bg-purple-400':'bg-pink-400'" x-text="rt.tags.name"></span>
                        </template>
                    </div>
                    <h3 class="text-base font-bold text-slate-800 line-clamp-2 mb-2.5 leading-snug" x-text="item.title"></h3>
                    <div class="text-xs text-gray-400 flex items-center justify-between pt-2 border-t border-gray-50">
                        <span class="flex items-center gap-1">ğŸ“… <span x-text="item.custom_date || 'æ—¥æœŸä¸è¯¦'"></span></span>
                    </div>
                </div>
            </template>
            <div class="py-6 text-center text-xs text-gray-400" x-text="isLoading ? 'ğŸš€ åŠ è½½ä¸­...' : (hasMore ? 'ä¸Šæ»‘åŠ è½½æ›´å¤š' : 'æ²¡æœ‰æ›´å¤šäº†')"></div>
        </div>
    </main>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailItem" x-cloak class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]" @click.away="detailItem=null">
            <div class="p-5 border-b flex justify-between items-start">
                <h2 class="text-lg font-bold text-slate-800 leading-snug" x-text="detailItem?.title"></h2>
                <button @click="detailItem=null" class="text-2xl text-gray-400">&times;</button>
            </div>
            <div class="p-5 overflow-y-auto custom-scrollbar">
                <!-- è§£é”æŒ‰é’® -->
                <div x-show="isLocked" class="mb-6 p-4 bg-blue-50 rounded-xl text-center border border-blue-100">
                    <p class="text-sm text-blue-800 mb-2 font-bold">ğŸ”’ æ­¤å¸–åŒ…å«å—é™å†…å®¹</p>
                    <button @click="unlockAll" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg">æ¶ˆè€— 1 æŠŠé’¥åŒ™è§£é”å…¨éƒ¨</button>
                </div>
                <!-- å†…å®¹å±•ç¤º -->
                <div class="space-y-4">
                    <template x-for="(block, idx) in detailContent" :key="idx">
                        <div class="break-words text-sm">
                            <template x-if="block.type === 'text'"><p class="whitespace-pre-wrap text-gray-700 leading-relaxed" x-text="block.value"></p></template>
                            <template x-if="block.type === 'image'">
                                <img :src="block.isLockedMask ? 'https://via.placeholder.com/400x200?text=LOCKED' : block.value" loading="lazy" class="rounded-lg w-full">
                            </template>
                            <template x-if="block.type === 'link'">
                                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                                    <div class="flex items-center gap-2 mb-1"><span class="text-lg">ğŸ”—</span><span class="font-bold text-gray-600 text-xs" x-text="block.linkType || 'é“¾æ¥'"></span></div>
                                    <template x-if="block.isLockedMask"><span class="text-gray-400 text-xs italic">*** å†…å®¹å·²éšè— ***</span></template>
                                    <template x-if="!block.isLockedMask"><a :href="block.value" target="_blank" class="text-xs text-blue-500 hover:underline break-all" x-text="block.value"></a></template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œå¼¹çª— -->
    <div x-show="modalMode" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl relative">
            <button @click="modalMode=null" class="absolute top-4 right-4 text-gray-300 text-xl">&times;</button>
            <h2 class="text-xl font-bold text-blue-600 mb-4 text-center">ç™»å½• / æ³¨å†Œ</h2>
            <div class="space-y-3">
                <input type="email" x-model="form.email" placeholder="QQé‚®ç®±" class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none">
                <div class="flex gap-2">
                    <input type="text" x-model="form.code" placeholder="é‚®ä»¶éªŒè¯ç " class="w-full p-2.5 bg-blue-50 rounded-lg text-sm outline-none">
                    <button @click="sendOtp" :disabled="timer>0" class="w-24 bg-blue-100 text-blue-600 text-xs font-bold rounded-lg" x-text="timer>0?timer:'å‘é€'"></button>
                </div>
                <button @click="verifyOtp" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm">è¿›å…¥è“é²¸å°ç«™</button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ä¸­å¿ƒ (ä»…å±•ç¤ºå…³é”®ä¿¡æ¯) -->
    <div x-show="showCenter" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50" @click.self="showCenter=false">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl relative">
            <div class="flex flex-col items-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold mb-3" x-text="profile?.username?.[0] || 'U'"></div>
                <h2 class="text-xl font-bold" x-text="profile?.username"></h2>
                <p class="text-sm text-gray-500" x-text="profile?.email"></p>
            </div>
            <div class="bg-blue-50 p-5 rounded-xl mb-4 text-center">
                <span class="text-sm text-gray-600 font-bold">ä»Šæ—¥å‰©ä½™é’¥åŒ™</span>
                <div class="text-4xl font-bold text-blue-600 my-2" x-text="profile?.keys_count || 0"></div>
                <div class="text-xs text-gray-400">è¿ç»­ç­¾åˆ°: <span x-text="profile?.consecutive_days || 0"></span> å¤©</div>
            </div>
            <button @click="logout" class="w-full py-2.5 bg-gray-100 text-gray-500 rounded-xl font-bold hover:bg-red-50 hover:text-red-500">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <script>
        function app() {
            return {
                user: null, profile: null,
                categories: [], resources: [], tags: [], 
                viewMode: 'list', currentCat: null, currentTagType: null, currentTagId: null,
                modalMode: null, showCenter: false, detailItem: null,
                form: { email: '', code: '' }, timer: 0,
                searchQ: '', sortType: 'date-desc', page: 0, hasMore: true, isLoading: false, showCatMenu: false,
                
                // è¯¦æƒ…å†…å®¹å¤„ç†ï¼ˆè„±æ•ï¼‰
                get detailContent() {
                    if(!this.detailItem) return [];
                    const content = this.detailItem.content_json || [];
                    // å¦‚æœå·²è§£é”(æœ¬åœ°åˆ¤æ–­)ï¼Œæ˜¾ç¤ºåŸæ–‡ï¼Œå¦åˆ™è„±æ•
                    const isUnlocked = this.checkUnlockedLocal(this.detailItem.id);
                    return content.map(b => {
                        if ((b.type === 'link' || b.locked) && !isUnlocked) {
                            return { ...b, isLockedMask: true }; // éšè— value
                        }
                        return { ...b, isLockedMask: false };
                    });
                },
                get isLocked() { return this.detailContent.some(b => b.isLockedMask); },

                async init() {
                    // åˆå§‹åŒ– Supabase ä¼šè¯
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        this.user = session.user;
                        await this.fetchProfile();
                    }
                    
                    // åŠ è½½åˆ†ç±»å’Œç¬¬ä¸€é¡µæ•°æ®
                    const { data: cats } = await supabase.from('categories').select('*').order('sort_order');
                    this.categories = cats || [];
                    this.doSearch(true);
                },

                // === æ•°æ®åŠ è½½ ===
                async doSearch(reset = false) {
                    if (this.isLoading) return;
                    if (reset) { this.page = 0; this.resources = []; this.hasMore = true; }
                    this.isLoading = true;

                    let query = supabase.from('resources').select(`
                        id, title, custom_date, created_at, category_id, content_json,
                        resource_tags!inner ( tags ( id, name, type ) )
                    `).range(this.page * 25, (this.page + 1) * 25 - 1);

                    // æ’åº
                    if (this.sortType === 'date-desc') query = query.order('custom_date', { ascending: false });
                    if (this.sortType === 'date-asc') query = query.order('custom_date', { ascending: true });

                    // ç­›é€‰
                    if (this.searchQ) query = query.ilike('title', `%${this.searchQ}%`);
                    if (this.currentCat) query = query.eq('category_id', this.currentCat.id);
                    if (this.currentTagId) query = query.eq('resource_tags.tags.id', this.currentTagId);
                    // æ³¨æ„ï¼šSupabase å…³è”è¿‡æ»¤éœ€è¦ç‰¹æ®Šå†™æ³•ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå¦‚æœæŠ¥é”™éœ€è°ƒæ•´ Filter é€»è¾‘

                    const { data, error } = await query;
                    
                    if (data && data.length > 0) {
                        // æ•´ç†æ•°æ®ç»“æ„ï¼ŒæŠŠåµŒå¥—çš„ tags æå‡ºæ¥æ–¹ä¾¿å‰ç«¯ç”¨
                        const formatted = data.map(r => ({
                            ...r,
                            tags: r.resource_tags.map(rt => rt.tags)
                        }));
                        this.resources = [...this.resources, ...formatted];
                    } else {
                        this.hasMore = false;
                    }
                    this.isLoading = false;
                },
                
                async handleScroll() {
                    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                    if (scrollTop + clientHeight >= scrollHeight - 50 && this.hasMore) {
                        this.page++;
                        await this.doSearch();
                    }
                },

                // === è®¤è¯ ===
                async sendOtp() {
                    if(!this.form.email) return alert('é‚®ç®±å¿…å¡«');
                    const { error } = await supabase.auth.signInWithOtp({ email: this.form.email });
                    if (error) alert(error.message);
                    else { alert('éªŒè¯ç å·²å‘é€'); this.timer=60; setInterval(()=>this.timer>0&&this.timer--,1000); }
                },
                async verifyOtp() {
                    const { data, error } = await supabase.auth.verifyOtp({ email: this.form.email, token: this.form.code, type: 'email' });
                    if (error) alert(error.message);
                    else {
                        this.user = data.user;
                        this.modalMode = null;
                        await this.fetchProfile();
                        alert('ç™»å½•æˆåŠŸï¼');
                    }
                },
                async fetchProfile() {
                    if (!this.user) return;
                    // è¿å¸¦åˆ·æ–°ç”¨æˆ·çš„é…é¢ï¼ˆè¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆï¼Œå®é™…é…é¢åˆ·æ–°åº”è¯¥åœ¨åç«¯è§¦å‘å™¨æˆ– Edge Function åšï¼‰
                    // æˆ‘ä»¬å‡è®¾ handle_new_user è§¦å‘å™¨å·²ç»åˆ›å»ºäº† profile
                    const { data } = await supabase.from('profiles').select('*').eq('id', this.user.id).single();
                    if (data) this.profile = data;
                    
                    // æ£€æŸ¥ä»Šæ—¥ç­¾åˆ°é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œè¡¥å‰ç«¯åˆ¤æ–­ï¼Œæˆ–è€…åç«¯ RPC
                },
                async logout() { await supabase.auth.signOut(); location.reload(); },

                // === äº¤äº’ ===
                filterCat(c) { this.currentCat = c; this.viewMode = 'list'; this.doSearch(true); this.showCatMenu = false; },
                async loadTags(type) {
                    this.currentTagType = type; this.viewMode = 'tags';
                    const { data } = await supabase.from('tags').select('*').eq('type', type);
                    this.tags = data || [];
                },
                filterByTag(t) { this.currentTagId = t.id; this.viewMode = 'list'; this.doSearch(true); },
                resetView() { this.viewMode = 'list'; this.currentCat = null; this.currentTagId = null; this.doSearch(true); },
                getCatName(id) { const c = this.categories.find(x => x.id === id); return c ? c.name : 'æœªåˆ†ç±»'; },
                openDetail(item) { this.detailItem = item; },

                // === è§£é”é€»è¾‘ (å®¢æˆ·ç«¯ç®€åŒ–ç‰ˆ) ===
                async checkUnlockedLocal(rid) {
                    if (!this.user) return false;
                    // æ£€æŸ¥ unlocked_items è¡¨
                    const { data } = await supabase.from('unlocked_items').select('id').eq('user_id', this.user.id).eq('resource_id', rid).single();
                    return !!data;
                },
                async unlockAll() {
                    if (!this.user) return this.modalMode = 'login';
                    if (this.profile.keys_count < 1) return alert('é’¥åŒ™ä¸è¶³ï¼');
                    
                    // 1. æ‰£é™¤é’¥åŒ™
                    const newCount = this.profile.keys_count - 1;
                    const { error: e1 } = await supabase.from('profiles').update({ keys_count: newCount }).eq('id', this.user.id);
                    if (e1) return alert('æ“ä½œå¤±è´¥');
                    
                    // 2. è®°å½•è§£é”
                    const today = new Date().toISOString().split('T')[0];
                    await supabase.from('unlocked_items').insert({ user_id: this.user.id, resource_id: this.detailItem.id, date_str: today });
                    
                    // 3. åˆ·æ–°çŠ¶æ€
                    this.profile.keys_count = newCount;
                    // å¼ºåˆ¶åˆ·æ–°å½“å‰å¼¹çª—çš„è§†å›¾
                    this.detailItem = { ...this.detailItem }; // è§¦å‘ reactivity
                }
            }
        }
    </script>
</body>
</html>
