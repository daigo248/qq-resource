<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸å°ç«™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; } 
        body { background: #f0f9ff; color: #334155; font-family: sans-serif; }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body x-data="app()">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white/90 backdrop-blur shadow-sm sticky top-0 z-40 border-b border-blue-100">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-blue-600 tracking-wider hover:text-blue-700 flex items-center gap-2">
                <span>ğŸ³</span> è“é²¸å°ç«™
            </a>
            <div>
                <template x-if="!user">
                    <button @click="openModal('login')" class="text-blue-500 font-bold hover:bg-blue-50 px-4 py-2 rounded-lg transition border border-transparent hover:border-blue-100">ç™»å½• / æ³¨å†Œ</button>
                </template>
                <template x-if="user">
                    <div class="flex items-center gap-4">
                        <button @click="showUserCenter" class="flex items-center gap-2 hover:bg-blue-50 px-3 py-1.5 rounded-full transition border border-transparent hover:border-blue-100 group">
                            <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold shadow-sm group-hover:bg-blue-200 transition" x-text="user.username ? user.username[0].toUpperCase() : 'U'"></div>
                            <div class="text-sm text-left hidden sm:block">
                                <div class="font-bold text-gray-700 group-hover:text-blue-700" x-text="user.username"></div>
                                <div class="text-xs text-blue-500">å‰©ä½™è§£é”: <span x-text="quota.remaining"></span>æ¬¡</div>
                            </div>
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        
        <!-- å·¥å…·æ ï¼šæœç´¢ + æ’åº -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-50 mb-6">
            <div class="flex flex-col sm:flex-row gap-3">
                <!-- æœç´¢æ¡† -->
                <div class="flex-1 flex gap-2">
                    <input type="text" x-model="searchQ" @keyup.enter="doSearch" placeholder="ğŸ” æœç´¢å¸–å­æ ‡é¢˜æˆ–æ—¥æœŸ..." class="flex-1 p-2.5 rounded-lg border border-gray-200 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-300 transition text-sm">
                    <button @click="doSearch" class="bg-blue-600 text-white px-5 rounded-lg font-bold hover:bg-blue-700 text-sm transition shadow-sm shadow-blue-200">æœç´¢</button>
                </div>
                
                <!-- æ’åºä¸‹æ‹‰æ¡† -->
                <div class="flex items-center gap-2 shrink-0">
                    <span class="text-xs text-gray-500 font-bold">æ’åº:</span>
                    <select x-model="sortType" class="p-2.5 rounded-lg border border-gray-200 bg-gray-50 text-sm focus:ring-2 focus:ring-blue-300 outline-none cursor-pointer">
                        <option value="date-desc">ğŸ“… æ—¥æœŸ (ä»æ–°åˆ°æ—§)</option>
                        <option value="date-asc">ğŸ“… æ—¥æœŸ (ä»æ—§åˆ°æ–°)</option>
                        <option value="title-asc">ğŸ”¤ åç§° (A-Z)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- åˆ†ç±» Tab (æ¨ªå‘æ»šåŠ¨) -->
        <div class="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
            <button @click="filterCat(null)" :class="!currentCat ? 'bg-blue-600 text-white shadow-md shadow-blue-200' : 'bg-white text-gray-600 hover:bg-blue-50 border border-gray-100'" class="px-5 py-2 rounded-full text-sm font-bold transition shrink-0">å…¨éƒ¨</button>
            <template x-for="cat in categories" :key="cat.id">
                <button @click="filterCat(cat.id)" :class="currentCat===cat.id ? 'bg-blue-600 text-white shadow-md shadow-blue-200' : 'bg-white text-gray-600 hover:bg-blue-50 border border-gray-100'" class="px-5 py-2 rounded-full text-sm font-bold transition shrink-0" x-text="cat.name"></button>
            </template>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div class="space-y-6 min-h-[300px]">
            <template x-for="item in processedResources" :key="item.id">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-50 hover:shadow-lg hover:-translate-y-1 transition duration-300 cursor-pointer group" @click="openDetail(item)">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-bold text-slate-800 group-hover:text-blue-600 transition line-clamp-2" x-text="item.title"></h3>
                        <span class="text-xs px-2.5 py-1 bg-blue-50 text-blue-600 rounded-md font-bold whitespace-nowrap ml-2" x-text="getCatName(item.category_id)"></span>
                    </div>
                    <div class="text-xs text-gray-400 flex flex-wrap gap-4 items-center">
                        <span class="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded">ğŸ“… <span x-text="item.custom_date || 'æ—¥æœŸä¸è¯¦'"></span></span>
                        <span class="flex items-center gap-1 hover:text-blue-500">ğŸ’¬ <span x-text="item.comment_count"></span></span>
                        <span class="flex items-center gap-1 hover:text-pink-500">â¤ï¸ <span x-text="item.like_count"></span></span>
                    </div>
                </div>
            </template>
            
            <div x-show="processedResources.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <div class="text-4xl mb-2">ğŸŒŠ</div>
                <p>è¿™é‡Œè¿˜æ˜¯ä¸€ç‰‡è“è‰²çš„æµ·æ´‹...</p>
                <p class="text-xs mt-2 text-gray-300">å°è¯•åˆ‡æ¢åˆ†ç±»æˆ–æœç´¢çœ‹çœ‹?</p>
            </div>
        </div>
    </main>

    <footer class="text-center py-8 text-sm text-gray-400 border-t border-blue-50 mt-8">
        &copy; è“é²¸å°ç«™ ACG Resource
    </footer>

    <!-- ç”¨æˆ·ä¸­å¿ƒå¼¹çª— -->
    <div x-show="showCenter" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl relative transform transition-all scale-100" @click.away="showCenter=false">
            <button @click="showCenter=false" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 text-xl">&times;</button>
            
            <div class="flex flex-col items-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold mb-3 shadow-inner" x-text="user.username ? user.username[0].toUpperCase() : 'U'"></div>
                <h2 class="text-xl font-bold text-gray-800" x-text="user.username"></h2>
                <p class="text-sm text-gray-500" x-text="user.email"></p>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 p-5 rounded-xl mb-4 shadow-sm">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-sm text-gray-600 font-bold">ä»Šæ—¥å‰©ä½™è§£é”</span>
                    <span class="text-2xl font-bold text-blue-600 leading-none" x-text="quota.remaining"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" :style="'width: ' + ((quota.remaining/quota.total)*100) + '%'"></div>
                </div>
                <div class="text-xs text-right text-gray-400 mt-1">æ€»é…é¢: <span x-text="quota.total"></span></div>
            </div>

            <div class="bg-yellow-50 p-4 rounded-xl text-xs text-yellow-800 border border-yellow-100 mb-6 leading-relaxed">
                <strong>âœ¨ è¿ç»­è§£é”å¥–åŠ±è§„åˆ™ï¼š</strong><br>
                â€¢ è¿ç»­æ¯å¤©ä½¿ç”¨è§£é”åŠŸèƒ½ï¼Œæ¬¡æ—¥é¢åº¦ <b>+1</b> (ä¸Šé™3æ¬¡)<br>
                â€¢ è‹¥ä¸­æ–­ä¸€å¤©ï¼Œæ¬¡æ—¥é¢åº¦é‡ç½®ä¸º <b>1æ¬¡</b><br>
                â€¢ å½“æ—¥å·²è§£é”å†…å®¹é‡å¤æŸ¥çœ‹ <b>ä¸æ¶ˆè€—</b> æ¬¡æ•°
            </div>

            <div class="space-y-3">
                <button @click="modalMode='contact'; showCenter=false" class="w-full py-2.5 border border-blue-200 text-blue-600 rounded-xl hover:bg-blue-50 font-bold transition">ğŸ“© è”ç³»ç®¡ç†å‘˜</button>
                <button @click="logout" class="w-full py-2.5 bg-gray-100 text-gray-500 rounded-xl hover:bg-red-50 hover:text-red-500 font-bold transition">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…/è¯„è®ºå¼¹çª— -->
    <div x-show="detailItem" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh] relative animate-fade-in-up" @click.away="detailItem=null">
            <!-- å¤´éƒ¨ -->
            <div class="p-6 border-b flex justify-between items-start bg-white rounded-t-2xl z-10 shrink-0">
                <div>
                    <h2 class="text-xl sm:text-2xl font-bold text-slate-800 leading-tight" x-text="detailItem?.title"></h2>
                    <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                        <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-bold" x-text="getCatName(detailItem?.category_id)"></span>
                        <span x-text="'ğŸ“… ' + (detailItem?.custom_date || 'æ—¥æœŸä¸è¯¦')"></span>
                    </div>
                </div>
                <button @click="detailItem=null" class="text-gray-300 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            
            <!-- å†…å®¹æ»šåŠ¨åŒº -->
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <!-- å¸–å­å†…å®¹ -->
                <div class="space-y-5 mb-10">
                    <template x-for="(block, idx) in detailItem?.content" :key="idx">
                        <div class="break-words">
                            <!-- æ–‡æœ¬ -->
                            <template x-if="block.type === 'text'">
                                <p class="whitespace-pre-wrap text-gray-700 leading-relaxed text-sm sm:text-base" x-text="block.value"></p>
                            </template>
                            
                            <!-- å›¾ç‰‡ -->
                            <template x-if="block.type === 'image'">
                                <div class="relative group rounded-xl overflow-hidden shadow-sm border border-gray-100">
                                    <template x-if="block.isLockedMask">
                                        <div class="w-full h-40 bg-gray-50 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 gap-2">
                                            <span class="text-3xl">ğŸ”’</span>
                                            <button @click="unlock(detailItem.id, idx)" class="text-blue-600 font-bold hover:underline text-sm">å›¾ç‰‡å—é™ (ç‚¹å‡»æ¶ˆè€—æ¬¡æ•°è§£é”)</button>
                                        </div>
                                    </template>
                                    <template x-if="!block.isLockedMask">
                                        <img :src="block.value" class="w-full object-contain max-h-[500px]">
                                    </template>
                                </div>
                            </template>

                            <!-- é“¾æ¥ -->
                            <template x-if="block.type === 'link'">
                                <div class="p-4 bg-blue-50 rounded-xl flex items-start gap-3 border border-blue-100">
                                    <span class="text-blue-500 text-lg">ğŸ”—</span>
                                    <div class="flex-1 overflow-hidden">
                                        <template x-if="block.isLockedMask">
                                            <button @click="unlock(detailItem.id, idx)" class="text-blue-600 font-bold hover:underline text-sm text-left">
                                                ğŸ”’ æ­¤é“¾æ¥å—é™ (ç‚¹å‡»æ¶ˆè€—1æ¬¡æŸ¥çœ‹æœºä¼š)
                                            </button>
                                        </template>
                                        <template x-if="!block.isLockedMask">
                                            <a :href="block.value" target="_blank" class="text-blue-600 hover:underline break-all font-mono text-sm block" x-text="block.value"></a>
                                            <p class="text-xs text-blue-400 mt-1">è¯·å¤åˆ¶æˆ–ç‚¹å‡»è®¿é—®</p>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- äº¤äº’åŒº -->
                <div class="border-t border-gray-100 pt-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-gray-700">è¯„è®ºåŒº</h3>
                        <button @click="like(detailItem.id)" class="flex items-center gap-2 px-4 py-2 bg-pink-50 text-pink-500 rounded-full hover:bg-pink-100 transition font-bold text-sm">
                            <span>â¤ï¸</span> <span x-text="detailItem?.like_count || 0"></span> å–œæ¬¢
                        </button>
                    </div>

                    <!-- å‘è¯„è®º -->
                    <div class="flex gap-2 mb-6">
                        <input type="text" x-model="newComment" @keyup.enter="postComment(detailItem.id)" placeholder="åˆ†äº«ä½ çš„çœ‹æ³•..." class="flex-1 border border-gray-200 bg-gray-50 p-3 rounded-xl text-sm focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition">
                        <button @click="postComment(detailItem.id)" class="bg-blue-600 text-white px-5 rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-200">å‘é€</button>
                    </div>

                    <!-- è¯„è®ºåˆ—è¡¨ -->
                    <div class="space-y-4">
                        <template x-for="c in comments" :key="c.id">
                            <div class="flex gap-3">
                                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-xs font-bold text-gray-500 shrink-0" x-text="c.username[0].toUpperCase()"></div>
                                <div class="bg-gray-50 p-3 rounded-2xl rounded-tl-none flex-1">
                                    <div class="flex justify-between items-baseline mb-1">
                                        <span class="font-bold text-blue-600 text-xs" x-text="c.username"></span>
                                        <span class="text-[10px] text-gray-400" x-text="new Date(c.created_at).toLocaleString()"></span>
                                    </div>
                                    <p class="text-sm text-gray-700 leading-relaxed" x-text="c.content"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="comments.length===0" class="text-gray-400 text-xs text-center py-4 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                            æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/è”ç³»æ¨¡æ€æ¡† (ä¿æŒåŸæ ·é€»è¾‘ï¼Œæ ·å¼å¾®è°ƒ) -->
    <div x-show="modalMode" x-cloak class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm shadow-2xl relative">
            <button @click="modalMode = null" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 text-xl">&times;</button>
            
            <!-- ç™»å½•è¡¨å• -->
            <div x-show="modalMode === 'login'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">æ¬¢è¿å›æ¥</h2>
                <div class="space-y-4">
                    <input type="text" x-model="form.loginId" placeholder="QQé‚®ç®± / ç”¨æˆ·å" class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-200 transition">
                    <input type="password" x-model="form.password" placeholder="å¯†ç " class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-200 transition">
                    <button @click="doLogin" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">ç«‹å³ç™»å½•</button>
                    <div class="flex justify-between text-xs text-gray-500 font-medium px-1">
                        <button @click="modalMode = 'register'" class="hover:text-blue-600">æ³¨å†Œæ–°è´¦å·</button>
                        <button @click="modalMode = 'reset'" class="hover:text-blue-600">å¿˜è®°å¯†ç ?</button>
                    </div>
                </div>
            </div>
            
            <!-- æ³¨å†Œè¡¨å• -->
            <div x-show="modalMode === 'register'">
                <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">åŠ å…¥æˆ‘ä»¬</h2>
                <div class="space-y-3">
                    <input type="email" x-model="form.email" placeholder="QQé‚®ç®±" class="w-full p-3 bg-blue-50 rounded-xl text-sm outline-none">
                    <div class="flex gap-2">
                        <input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-3 bg-blue-50 rounded-xl text-sm outline-none">
                        <button @click="sendCode('register')" :disabled="timer>0" class="w-24 bg-blue-100 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-200 transition" x-text="timer>0?timer+'s':'å‘é€éªŒè¯ç '"></button>
                    </div>
                    <input type="text" x-model="form.username" placeholder="è®¾ç½®ç”¨æˆ·å" class="w-full p-3 bg-blue-50 rounded-xl text-sm outline-none">
                    <input type="password" x-model="form.password" placeholder="è®¾ç½®å¯†ç " class="w-full p-3 bg-blue-50 rounded-xl text-sm outline-none">
                    <button @click="doRegister" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 mt-2 shadow-lg">æ³¨å†Œå¹¶ç™»å½•</button>
                    <div class="text-center text-xs text-gray-500 mt-2"><button @click="modalMode='login'" class="hover:text-blue-600">å·²æœ‰è´¦å·? å»ç™»å½•</button></div>
                </div>
            </div>

            <!-- é‡ç½®å¯†ç  -->
            <div x-show="modalMode === 'reset'">
                <h2 class="text-xl font-bold mb-4 text-center text-gray-800">é‡ç½®å¯†ç </h2>
                <div class="space-y-3">
                    <input type="email" x-model="form.email" placeholder="æ³¨å†Œé‚®ç®±" class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none border border-gray-200">
                    <div class="flex gap-2">
                        <input type="text" x-model="form.code" placeholder="éªŒè¯ç " class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none border border-gray-200">
                        <button @click="sendCode('reset')" :disabled="timer>0" class="w-20 bg-gray-200 text-gray-600 text-xs rounded-xl font-bold" x-text="timer>0?timer+'s':'å‘é€'"></button>
                    </div>
                    <input type="password" x-model="form.newPassword" placeholder="æ–°å¯†ç " class="w-full p-3 bg-gray-50 rounded-xl text-sm outline-none border border-gray-200">
                    <button @click="doReset" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold mt-2 hover:bg-black">ç¡®è®¤é‡ç½®</button>
                    <div class="text-center text-xs text-gray-500 mt-2"><button @click="modalMode='login'" class="hover:text-blue-600">è¿”å›ç™»å½•</button></div>
                </div>
            </div>

            <!-- è”ç³»ç®¡ç†å‘˜ -->
            <div x-show="modalMode === 'contact'">
                <h2 class="text-xl font-bold text-blue-600 mb-2 text-center">è”ç³»ç®¡ç†å‘˜</h2>
                <p class="text-xs text-center text-gray-400 mb-4">æˆ‘ä»¬å°†é€šè¿‡é‚®ä»¶å›å¤æ‚¨</p>
                <div class="space-y-4">
                    <textarea x-model="contactMsg" placeholder="è¯·å¡«å†™æ‚¨çš„ç•™è¨€å†…å®¹..." rows="4" class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl outline-none text-sm resize-none"></textarea>
                    <input type="text" x-model="contactInfo" placeholder="æ‚¨çš„è”ç³»æ–¹å¼(QQ/é‚®ç®±)" class="w-full p-3 bg-blue-50 border border-blue-100 rounded-xl outline-none text-sm">
                    <button @click="sendContact" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">å‘é€ç•™è¨€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                token: localStorage.getItem('token') || '',
                categories: [], resources: [], currentCat: null, quota: {total:0, remaining:0},
                modalMode: null, showCenter: false, detailItem: null,
                form: { loginId:'', email:'', username:'', password:'', newPassword:'', code:'' },
                searchQ: '', newComment: '', comments: [], contactMsg:'', contactInfo:'', timer:0,
                sortType: 'date-desc', // é»˜è®¤æ’åºï¼šæ—¥æœŸå€’åº

                // æ ¸å¿ƒï¼šè¿‡æ»¤ä¸æ’åºé€»è¾‘
                get processedResources() {
                    let list = this.resources;
                    
                    // 1. åˆ†ç±»è¿‡æ»¤ (ä¿®å¤: å¼ºåˆ¶ç±»å‹è½¬æ¢æ¯”è¾ƒï¼Œé˜²æ­¢ string/int ä¸åŒ¹é…)
                    if(this.currentCat) {
                        list = list.filter(r => r.category_id == this.currentCat);
                    }

                    // 2. æ’åº
                    return list.sort((a, b) => {
                        // è¾…åŠ©ï¼šè·å–ç”¨äºæ’åºçš„æ—¥æœŸå¯¹è±¡
                        const getDate = (item) => {
                            // ä¼˜å…ˆå°è¯•è§£æ custom_date (å¦‚ "2025å¹´12æœˆ8æ—¥")
                            if (item.custom_date) {
                                // ç®€å•çš„ä¸­æ–‡æ—¥æœŸè§£ææ›¿æ¢
                                const s = item.custom_date.replace(/å¹´/g, '/').replace(/æœˆ/g, '/').replace(/æ—¥/g, '');
                                const d = new Date(s);
                                if (!isNaN(d)) return d;
                            }
                            // å¤±è´¥åˆ™ä½¿ç”¨åˆ›å»ºæ—¶é—´
                            return new Date(item.created_at);
                        };

                        if (this.sortType === 'date-desc') return getDate(b) - getDate(a);
                        if (this.sortType === 'date-asc') return getDate(a) - getDate(b);
                        if (this.sortType === 'title-asc') return a.title.localeCompare(b.title, 'zh');
                        return 0;
                    });
                },

                async init() {
                    if(this.token) this.refreshUser();
                    // åˆå§‹åŒ–åŠ è½½æ‰€æœ‰
                    await this.doSearch(); 
                },

                // æœç´¢æ—¶ä»åç«¯æ‹‰å–
                async doSearch() {
                    try {
                        const res = await fetch(`/api/public/home?q=${this.searchQ}`);
                        const data = await res.json();
                        this.categories = data.categories;
                        this.resources = data.resources;
                    } catch(e) { console.error(e); }
                },

                async refreshUser() {
                    const res = await fetch('/api/user/info', { headers: {'Authorization': `Bearer ${this.token}`} });
                    if(res.ok) {
                        const data = await res.json();
                        this.user = data.user; this.quota = data.quota;
                        localStorage.setItem('user', JSON.stringify(data.user));
                    } else this.logout();
                },

                showUserCenter() { this.refreshUser(); this.showCenter = true; },
                openModal(mode) { this.modalMode = mode; this.form = {loginId:'', email:'', username:'', password:'', newPassword:'', code:''}; },

                // è¾…åŠ©ï¼šè·å–åˆ†ç±»åç§°
                getCatName(id) {
                    if(!id) return 'æœªåˆ†ç±»';
                    const c = this.categories.find(cat => cat.id == id);
                    return c ? c.name : 'æœªçŸ¥';
                },

                // è®¤è¯ç›¸å…³ (ç²¾ç®€ç‰ˆ)
                async sendCode(type) {
                    if(!this.form.email) return alert('é‚®ç®±å¿…å¡«');
                    const res = await fetch('/api/auth/send-code', {method:'POST', body:JSON.stringify({email:this.form.email, type})});
                    if(res.ok){ alert('å‘é€æˆåŠŸ'); this.timer=60; setInterval(()=>this.timer>0&&this.timer--,1000); } else alert((await res.json()).error);
                },
                async doRegister() {
                    const res = await fetch('/api/auth/register', {method:'POST', body:JSON.stringify(this.form)});
                    const data = await res.json();
                    if(res.ok) this.loginSuccess(data); else alert(data.error);
                },
                async doLogin() {
                    const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.form, isAdmin:false})});
                    const data = await res.json();
                    if(res.ok) this.loginSuccess(data); else alert(data.error);
                },
                async doReset() {
                    const res = await fetch('/api/auth/reset-password', {method:'POST', body:JSON.stringify(this.form)});
                    if(res.ok) { alert('é‡ç½®æˆåŠŸ'); this.modalMode='login'; } else alert((await res.json()).error);
                },
                loginSuccess(data) {
                    this.user=data.user; this.token=data.token;
                    localStorage.setItem('user', JSON.stringify(data.user)); localStorage.setItem('token', data.token);
                    this.modalMode=null; this.refreshUser();
                },
                logout() { localStorage.clear(); location.reload(); },

                // è¯¦æƒ…äº¤äº’
                async unlock(resourceId, idx) {
                    if(!this.user) return this.modalMode = 'login';
                    if(!confirm('è§£é”å°†æ¶ˆè€—æ¬¡æ•° (ä»Šæ—¥é‡å¤æŸ¥çœ‹æ­¤å†…å®¹ä¸æ¶ˆè€—)ï¼Œç¡®å®šå—ï¼Ÿ')) return;
                    const res = await fetch('/api/resource/unlock', {
                        method:'POST', headers:{'Authorization':`Bearer ${this.token}`},
                        body:JSON.stringify({resourceId, blockIndex:idx})
                    });
                    const data = await res.json();
                    if(res.ok) {
                        this.detailItem.content[idx] = {...this.detailItem.content[idx], value:data.realValue, isLockedMask:false};
                        this.refreshUser(); 
                    } else alert(data.error);
                },
                async openDetail(item) {
                    this.detailItem = JSON.parse(JSON.stringify(item)); // æ·±æ‹·è´é˜²æ­¢æ±¡æŸ“åˆ—è¡¨
                    const res = await fetch(`/api/resource/comments/${item.id}`);
                    this.comments = await res.json();
                },
                async postComment(rid) {
                    if(!this.user) return this.modalMode = 'login';
                    if(!this.newComment) return;
                    await fetch('/api/resource/comment', {
                        method:'POST', headers:{'Authorization':`Bearer ${this.token}`},
                        body:JSON.stringify({resourceId:rid, content:this.newComment})
                    });
                    this.newComment = '';
                    this.openDetail(this.detailItem); // åˆ·æ–°è¯„è®º
                },
                async like(rid) {
                    if(!this.user) return this.modalMode = 'login';
                    await fetch('/api/resource/like', {method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:JSON.stringify({resourceId:rid})});
                    this.detailItem.like_count++;
                },
                async sendContact() {
                    if(!this.contactMsg) return;
                    await fetch('/api/contact', {method:'POST', body:JSON.stringify({msg:this.contactMsg, contact:this.contactInfo})});
                    alert('ç•™è¨€å·²å‘é€ç»™ç®¡ç†å‘˜'); this.modalMode=null;
                },
                
                // ä¿®å¤çš„åˆ†ç±»è¿‡æ»¤å™¨
                filterCat(id) { 
                    this.currentCat = id; 
                }
            }
        }
    </script>
</body>
</html>
