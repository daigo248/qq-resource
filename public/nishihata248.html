<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>蓝鲸后台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="admin()">
    <div x-show="!token" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow w-96"><h1 class="font-bold mb-4">登录</h1><input type="text" x-model="loginForm.loginId" class="w-full border p-2 mb-2"><input type="password" x-model="loginForm.password" class="w-full border p-2 mb-4"><button @click="login" class="w-full bg-blue-600 text-white py-2 rounded">Login</button></div>
    </div>

    <div x-show="token" class="min-h-screen flex flex-col h-screen" x-cloak>
        <nav class="bg-slate-800 text-white p-4 shrink-0 flex justify-between">
            <span class="font-bold">🐋 蓝鲸管理</span>
            <div class="space-x-1 text-sm flex">
                <button @click="switchTab('post')" :class="tab==='post'?'text-blue-300':''">发布</button>
                <button @click="switchTab('list')" :class="tab==='list'?'text-blue-300':''">文章</button>
                <button @click="switchTab('tags')" :class="tab==='tags'?'text-blue-300':''">标签管理</button>
                <button @click="switchTab('keywords')" :class="tab==='keywords'?'text-blue-300':''">自动关联</button>
                <button @click="switchTab('users')" :class="tab==='users'?'text-blue-300':''">用户</button>
                <button @click="switchTab('msgs')" :class="tab==='msgs'?'text-blue-300':''">私信</button>
                <button @click="logout" class="text-red-400 ml-2">退出</button>
            </div>
        </nav>

        <main class="flex-1 overflow-hidden p-6">
            
            <!-- 1. 发布/编辑 -->
            <div x-show="tab === 'post'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <div class="space-y-4 max-w-4xl mx-auto">
                    <h2 class="text-lg font-bold" x-text="isEdit?'修改':'发布 (自动关联标签)'"></h2>
                    <input type="text" x-model="post.title" placeholder="标题" class="w-full border p-2 rounded">
                    <div class="flex gap-4"><select x-model="post.category_id" class="border p-2 rounded flex-1"><option value="">分类...</option><template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template></select><input type="text" x-model="post.manualDate" placeholder="日期" class="border p-2 rounded flex-1"></div>
                    
                    <div class="border p-4 rounded bg-blue-50">
                        <h3 class="text-sm font-bold text-gray-700 mb-2">🏷️ 手动标签 (系统会自动根据内容追加)</h3>
                        <div class="space-y-2"><template x-for="(t, idx) in post.tags" :key="idx"><div class="flex gap-2 items-center bg-white p-2 rounded border"><select x-model="t.type" class="border p-1 rounded text-xs"><option value="番组">番组</option><option value="艺人">艺人</option></select><input type="text" x-model="t.name" @blur="autoFillTagImg(idx)" placeholder="标签名" class="border p-1 rounded text-sm flex-1"><input type="text" x-model="t.image_url" placeholder="图片URL" class="border p-1 rounded text-xs w-1/3"><button @click="post.tags.splice(idx,1)" class="text-red-500">✕</button></div></template><button @click="post.tags.push({type:'番组',name:'',image_url:''})" class="text-xs bg-blue-200 px-2 rounded">+标签</button></div>
                    </div>
                    
                    <div class="border rounded p-4 bg-gray-50 space-y-2">
                        <template x-for="(block, idx) in post.blocks" :key="idx"><div class="flex gap-2 items-center bg-white p-2 rounded border"><span x-text="idx+1" class="text-xs text-gray-400"></span><select x-model="block.type" class="border text-sm p-1 rounded"><option value="text">文本</option><option value="link">链接</option><option value="image">图片</option></select><div class="flex-1 space-y-1"><input type="text" x-model="block.value" class="w-full border p-1 rounded text-sm"><div x-show="block.type==='link'" class="flex gap-2 text-xs"><select x-model="block.linkType" class="border p-1 rounded"><option value="夸克">夸克</option><option value="百度">百度</option><option value="其他">其他</option></select><input x-show="block.linkType==='其他'" type="text" x-model="block.customLinkType" placeholder="类型" class="border p-1 rounded w-20"></div><input x-show="block.type==='image'" type="file" @change="uploadImg($event, idx)" class="text-xs"></div><label class="flex items-center gap-1 text-xs bg-gray-100 p-1 rounded"><input type="checkbox" x-model="block.locked">🔒</label><button @click="post.blocks.splice(idx,1)" class="text-red-500">✕</button></div></template>
                        <div class="flex gap-2"><button @click="addBlock('text')" class="text-xs bg-gray-200 px-2 rounded">+文</button><button @click="addBlock('link')" class="text-xs bg-gray-200 px-2 rounded">+链</button><button @click="addBlock('image')" class="text-xs bg-gray-200 px-2 rounded">+图</button></div>
                    </div>
                    <button @click="publish" class="w-full bg-blue-600 text-white py-2 rounded">提交</button>
                </div>
            </div>

            <!-- 2. 文章列表 -->
            <div x-show="tab === 'list'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <div class="flex gap-2 mb-4"><select x-model="filterCatId" @change="loadResources" class="border p-2 rounded"><option value="">全部分类</option><template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template></select><input type="text" x-model="searchQ" class="border p-2 flex-1 rounded"><button @click="loadResources" class="bg-blue-600 text-white px-4 rounded">搜</button></div>
                <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th>ID</th><th>标题</th><th>分类</th><th>日期</th><th>操作</th></tr></thead><tbody><template x-for="r in resourceList" :key="r.id"><tr class="border-b"><td class="p-2" x-text="r.id"></td><td x-text="r.title"></td><td x-text="getCatName(r.category_id)"></td><td x-text="r.custom_date"></td><td><button @click="editResource(r.id)" class="text-blue-600 mr-2">改</button><button @click="delResource(r.id)" class="text-red-600">删</button></td></tr></template></tbody></table>
            </div>

            <!-- 3. 标签管理 (新) -->
            <div x-show="tab === 'tags'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-bold">标签管理</h2><span class="text-xs text-gray-500">点击标签可查看其关联的帖子</span></div>
                
                <div class="mb-6">
                    <h3 class="font-bold text-purple-600 mb-2">📺 番组标签</h3>
                    <div class="flex flex-wrap gap-3">
                        <template x-for="t in allTags.filter(x=>x.type==='番组')" :key="t.id">
                            <div @click="loadTagPosts(t.id)" class="border p-2 rounded cursor-pointer hover:bg-purple-50 flex items-center gap-2">
                                <img :src="t.image_url||'https://via.placeholder.com/30'" class="w-8 h-8 rounded object-cover">
                                <div><div class="font-bold text-sm" x-text="t.name"></div><div class="text-[10px] text-gray-400" x-text="t.post_count+' 帖'"></div></div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold text-pink-600 mb-2">🎤 艺人标签</h3>
                    <div class="flex flex-wrap gap-3">
                        <template x-for="t in allTags.filter(x=>x.type==='艺人')" :key="t.id">
                            <div @click="loadTagPosts(t.id)" class="border p-2 rounded cursor-pointer hover:bg-pink-50 flex items-center gap-2">
                                <img :src="t.image_url||'https://via.placeholder.com/30'" class="w-8 h-8 rounded object-cover">
                                <div><div class="font-bold text-sm" x-text="t.name"></div><div class="text-[10px] text-gray-400" x-text="t.post_count+' 帖'"></div></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 选定标签的文章列表 -->
                <div x-show="tagPosts.length > 0" class="border-t pt-4">
                    <h3 class="font-bold mb-2">该标签下的帖子:</h3>
                    <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th>ID</th><th>标题</th><th>操作</th></tr></thead>
                        <tbody><template x-for="r in tagPosts" :key="r.id"><tr class="border-b"><td class="p-2" x-text="r.id"></td><td x-text="r.title"></td><td><button @click="editResource(r.id)" class="text-blue-600">修改</button></td></tr></template></tbody>
                    </table>
                </div>
            </div>

            <!-- 4. 自动关联管理 (新) -->
            <div x-show="tab === 'keywords'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">
                <h2 class="text-lg font-bold mb-4">自动标签关联规则</h2>
                <div class="flex gap-2 mb-4 p-4 bg-gray-50 rounded">
                    <input type="text" x-model="newKw.keyword" placeholder="关键词 (如: 张三)" class="border p-2 rounded text-sm">
                    <input type="text" x-model="newKw.tagName" placeholder="对应标签名 (如: 张三)" class="border p-2 rounded text-sm">
                    <select x-model="newKw.tagType" class="border p-2 rounded text-sm"><option value="艺人">艺人</option><option value="番组">番组</option></select>
                    <button @click="addKeyword" class="bg-green-600 text-white px-4 rounded text-sm">添加规则</button>
                </div>
                <table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th>关键词</th><th>自动关联标签</th><th>操作</th></tr></thead>
                    <tbody><template x-for="k in keywords" :key="k.id"><tr class="border-b"><td class="p-3 font-bold" x-text="k.keyword"></td><td x-text="k.tag_name + ' (' + k.tag_type + ')'"></td><td><button @click="delKeyword(k.id)" class="text-red-500">删除</button></td></tr></template></tbody>
                </table>
            </div>

            <!-- 5. 用户 & 6. 私信 (略微精简，保持原有逻辑) -->
            <div x-show="tab === 'users'" class="bg-white p-6 rounded shadow h-full overflow-y-auto">... (保持原有用户管理代码) ...</div>
            <div x-show="tab === 'msgs'" class="bg-white rounded shadow h-full flex overflow-hidden border">... (保持原有私信管理代码) ...</div>
        </main>
    </div>

    <script>
        function admin() {
            return {
                token: localStorage.getItem('adm_token') || '', tab: 'post', isEdit: false,
                loginForm: { loginId: '', password: '' }, categories: [], resourceList: [], users: [], searchQ: '', filterCatId: '',
                post: { id: null, title: '', category_id: 3, blocks: [], manualDate: '', tags: [] }, // 默认综艺(ID:3)
                
                // 新增数据
                allTags: [], tagPosts: [], keywords: [], newKw: {keyword:'', tagName:'', tagType:'艺人'},
                
                // 私信/用户数据 (保持)
                inboxList: [], activeChatUser: null, currentChatMsgs: [], replyContent: '', selectedUsers: [],

                async init() { if(this.token) { this.loadCats(); this.loadResources(); } },
                async login() { const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.loginForm, isAdmin:true})}); const data = await res.json(); if(res.ok) { this.token = data.token; localStorage.setItem('adm_token', data.token); this.loadCats(); } else alert(data.error); },
                logout() { this.token=''; localStorage.removeItem('adm_token'); location.reload(); },
                auth() { return {'Authorization': `Bearer ${this.token}`}; },
                
                switchTab(t) { 
                    this.tab = t; 
                    if(t==='post') this.resetPost(); 
                    if(t==='list') this.loadResources();
                    if(t==='tags') this.loadAllTags();
                    if(t==='keywords') this.loadKeywords();
                    if(t==='users') this.loadUsers();
                    if(t==='msgs') this.loadInbox();
                },

                // 资源逻辑
                async loadCats() { this.categories = (await (await fetch('/api/public/home')).json()).categories; },
                async loadResources() { 
                    let url = `/api/admin/resources?q=${this.searchQ}`; if(this.filterCatId) url+=`&catId=${this.filterCatId}`;
                    const res = await fetch(url, {headers:this.auth()}); this.resourceList = await res.json(); 
                },
                getCatName(id) { const c = this.categories.find(cat => cat.id == id); return c ? c.name : '未分类'; },
                
                async editResource(id) { 
                    const res = await fetch(`/api/admin/resource/${id}`, {headers:this.auth()}); const data = await res.json(); 
                    this.post = { id: data.id, title: data.title, category_id: data.category_id, blocks: JSON.parse(data.content_json||'[]'), manualDate: data.custom_date, tags: data.tags||[] }; 
                    this.isEdit=true; this.tab='post'; 
                },
                async publish() { 
                    if(!this.post.title) return alert('标题必填');
                    if(!this.post.blocks.some(b=>b.type==='link')) return alert('第一条链接为必填项');
                    this.post.blocks.forEach(b => { if(b.type==='link' && b.linkType==='其他') b.linkType = b.customLinkType; });
                    const res = await fetch('/api/admin/resource', {method:'POST', headers:this.auth(), body:JSON.stringify(this.post)}); if(res.ok) { alert('成功'); this.tab='list'; this.loadResources(); this.resetPost(); } else alert((await res.json()).error); 
                },
                addBlock(type) { this.post.blocks.push({ type, value: '', locked: type === 'link', linkType: '夸克' }); },
                resetPost() { this.post = { id: null, title: '', category_id: 3, blocks: [{ type: 'link', value: '', locked: true, linkType: '夸克' }], manualDate: '', tags: [] }; this.isEdit = false; },
                async uploadImg(e, idx) { const f = e.target.files[0]; if(!f) return; const fd = new FormData(); fd.append('file', f); try { const res = await fetch('/api/admin/upload', {method:'POST', headers:this.auth(), body:fd}); const d = await res.json(); if(d.url) this.post.blocks[idx].value = d.url; } catch(e){} },
                async autoFillTagImg(idx) { const t=this.post.tags[idx]; if(!t.name) return; const res=await fetch(`/api/public/tag-image?name=${t.name}&type=${t.type}`); const d=await res.json(); if(d.imageUrl && !t.image_url) t.image_url=d.imageUrl; },

                // 标签管理
                async loadAllTags() { const res = await fetch('/api/admin/tags/all', {headers:this.auth()}); this.allTags = await res.json(); this.tagPosts = []; },
                async loadTagPosts(tagId) { const res = await fetch(`/api/admin/resources?tagId=${tagId}`, {headers:this.auth()}); this.tagPosts = await res.json(); },
                
                // 关键词管理
                async loadKeywords() { const res = await fetch('/api/admin/tag-keywords', {headers:this.auth()}); this.keywords = await res.json(); },
                async addKeyword() {
                    if(!this.newKw.keyword || !this.newKw.tagName) return;
                    await fetch('/api/admin/tag-keywords', {method:'POST', headers:this.auth(), body:JSON.stringify({...this.newKw, action:'add'})});
                    this.newKw.keyword=''; this.loadKeywords();
                },
                async delKeyword(id) { if(!confirm('删?')) return; await fetch('/api/admin/tag-keywords', {method:'POST', headers:this.auth(), body:JSON.stringify({id, action:'del'})}); this.loadKeywords(); },

                // 其他 (用户/私信等 保持之前逻辑)
                async loadUsers() { const res = await fetch('/api/admin/users', { headers:this.auth() }); if(res.ok) this.users = await res.json(); },
                async loadInbox() { const res = await fetch('/api/admin/inbox', { headers:this.auth() }); if(res.ok) this.inboxList = await res.json(); },
                async selectChat(u) { this.activeChatUser = u; const res = await fetch(`/api/admin/messages/${u.id}`, { headers:this.auth() }); if(res.ok) { this.currentChatMsgs = await res.json(); this.$nextTick(() => { const c = document.getElementById('adminChatContainer'); if(c) c.scrollTop = c.scrollHeight; }); } },
                async sendReply() { if(!this.replyContent) return; const res = await fetch('/api/admin/message/reply', { method: 'POST', headers: this.auth(), body: JSON.stringify({ userId: this.activeChatUser.id, content: this.replyContent }) }); if(res.ok) { this.replyContent = ''; this.selectChat(this.activeChatUser); } },
                async delResource(id) { if(confirm('删?')) { await fetch('/api/admin/resource/delete', {method:'POST', headers:this.auth(), body:JSON.stringify({id})}); this.loadResources(); } },
                async editQuota(u) { const l = prompt('钥匙数:', u.daily_limit||1); if(l) await fetch('/api/admin/user/quota', { method:'POST', headers:this.auth(), body:JSON.stringify({ userId:u.id, config:{limit:parseInt(l)} }) }); this.loadUsers(); },
                toggleAll(e) { this.selectedUsers = e.target.checked ? this.users.map(u => u.id) : []; },
                async batchAction(action) { if(!confirm(`确认 ${action}?`)) return; await fetch('/api/admin/users/batch', { method:'POST', headers:this.auth(), body:JSON.stringify({ userIds: this.selectedUsers, action }) }); this.loadUsers(); },
            }
        }
    </script>
</body>
</html>
