<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸ä¸­æ§å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script>
        // === é…ç½® ===
        const SUPABASE_URL = 'https://ä½ çš„é¡¹ç›®ID.supabase.co';
        const SUPABASE_ANON_KEY = 'ä½ çš„anon_key';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
</head>
<body class="bg-gray-100" x-data="admin()">
    
    <!-- ç™»å½•ç•Œé¢ -->
    <div x-show="!isAdmin" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow w-96 text-center">
            <h1 class="font-bold mb-4 text-xl">ç®¡ç†å‘˜ç™»å½•</h1>
            <p class="text-xs text-gray-400 mb-4">è¯·ä½¿ç”¨æ‚¨çš„ç®¡ç†è´¦å·é‚®ç®±ç™»å½•</p>
            <input type="email" x-model="email" placeholder="é‚®ç®±" class="w-full border p-2 mb-2 rounded">
            <div class="flex gap-2">
                <input type="text" x-model="code" placeholder="éªŒè¯ç " class="w-full border p-2 mb-4 rounded">
                <button @click="sendOtp" class="bg-blue-100 text-blue-600 px-3 py-2 rounded text-xs h-10">å‘é€</button>
            </div>
            <button @click="login" class="w-full bg-slate-800 text-white py-2 rounded">éªŒè¯å¹¶è¿›å…¥</button>
        </div>
    </div>

    <!-- åå°ä¸»ç•Œé¢ -->
    <div x-show="isAdmin" class="min-h-screen flex flex-col" x-cloak>
        <nav class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <span class="font-bold text-lg">ğŸ‹ ä¸­æ§å°</span>
            <div class="space-x-4 text-sm">
                <button @click="tab='post'" :class="tab==='post'?'text-blue-300':''">å‘å¸ƒ</button>
                <button @click="tab='list'" :class="tab==='list'?'text-blue-300':''">æ–‡ç« </button>
                <button @click="tab='tags'" :class="tab==='tags'?'text-blue-300':''">æ ‡ç­¾</button>
                <button @click="logout" class="text-red-400">é€€å‡º</button>
            </div>
        </nav>

        <main class="flex-1 p-6 max-w-5xl mx-auto w-full">
            
            <!-- å‘å¸ƒé¡µ -->
            <div x-show="tab === 'post'" class="bg-white p-6 rounded shadow">
                <h2 class="text-xl font-bold mb-4">å‘å¸ƒæ–°èµ„æº</h2>
                <input type="text" x-model="post.title" class="w-full border p-2 rounded mb-4" placeholder="æ ‡é¢˜">
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">å†…å®¹å— (é“¾æ¥/æ–‡å­—/å›¾ç‰‡)</label>
                    <template x-for="(block, idx) in post.blocks" :key="idx">
                        <div class="flex gap-2 mb-2 bg-gray-50 p-2 rounded">
                            <select x-model="block.type" class="border p-1 rounded text-sm">
                                <option value="text">æ–‡æœ¬</option>
                                <option value="link">é“¾æ¥</option>
                                <option value="image">å›¾ç‰‡</option>
                            </select>
                            <input type="text" x-model="block.value" class="flex-1 border p-1 rounded text-sm" placeholder="å†…å®¹">
                            <input x-show="block.type==='image'" type="file" @change="uploadImage($event, idx)" class="text-xs">
                            <button @click="post.blocks.splice(idx, 1)" class="text-red-500">âœ•</button>
                        </div>
                    </template>
                    <button @click="addBlock" class="text-sm text-blue-500">+ æ·»åŠ å—</button>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2">å…³è”æ ‡ç­¾ (åç§°, ç§ç±»)</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" x-model="newTag.name" placeholder="æ ‡ç­¾å" class="border p-1 rounded w-32">
                        <select x-model="newTag.type" class="border p-1 rounded"><option value="ç•ªç»„">ç•ªç»„</option><option value="è‰ºäºº">è‰ºäºº</option></select>
                        <button @click="addTag" class="bg-gray-200 px-3 rounded text-sm">æ·»åŠ </button>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <template x-for="(t, i) in post.tags" :key="i">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs flex items-center gap-1">
                                <span x-text="t.name"></span>
                                <button @click="post.tags.splice(i,1)" class="text-blue-500 font-bold">&times;</button>
                            </span>
                        </template>
                    </div>
                </div>

                <button @click="publish" class="w-full bg-blue-600 text-white py-3 rounded font-bold">æäº¤å‘å¸ƒ</button>
            </div>

            <!-- åˆ—è¡¨é¡µ -->
            <div x-show="tab === 'list'">
                <h2 class="text-xl font-bold mb-4">èµ„æºåˆ—è¡¨</h2>
                <div class="space-y-2">
                    <template x-for="r in resources" :key="r.id">
                        <div class="bg-white p-4 rounded shadow flex justify-between items-center">
                            <span x-text="r.title" class="font-bold"></span>
                            <button @click="deleteResource(r.id)" class="text-red-500 text-sm">åˆ é™¤</button>
                        </div>
                    </template>
                </div>
                <button @click="loadResources" class="mt-4 text-blue-500 text-sm">åˆ·æ–°åˆ—è¡¨</button>
            </div>

        </main>
    </div>

    <script>
        function admin() {
            return {
                isAdmin: false, user: null, tab: 'post',
                email: '', code: '',
                post: { title: '', blocks: [], tags: [] },
                newTag: { name: '', type: 'ç•ªç»„' },
                resources: [],

                async init() {
                    const { data } = await supabase.auth.getSession();
                    if(data.session) await this.checkAdmin(data.session.user.id);
                },

                async sendOtp() {
                    const { error } = await supabase.auth.signInWithOtp({ email: this.email });
                    if(error) alert(error.message); else alert('éªŒè¯ç å·²å‘é€');
                },

                async login() {
                    const { data, error } = await supabase.auth.verifyOtp({ email: this.email, token: this.code, type: 'email' });
                    if(error) return alert(error.message);
                    await this.checkAdmin(data.user.id);
                },

                async checkAdmin(uid) {
                    const { data } = await supabase.from('profiles').select('role').eq('id', uid).single();
                    if (data && data.role === 'admin') {
                        this.isAdmin = true;
                        this.user = uid;
                        this.loadResources();
                    } else {
                        alert('éç®¡ç†å‘˜è´¦å·');
                        supabase.auth.signOut();
                    }
                },
                logout() { supabase.auth.signOut(); location.reload(); },

                // å‘å¸ƒé€»è¾‘
                addBlock() { this.post.blocks.push({ type: 'text', value: '', locked: false }); },
                addTag() { 
                    if(this.newTag.name) {
                        this.post.tags.push({ ...this.newTag });
                        this.newTag.name = ''; 
                    }
                },
                async uploadImage(e, idx) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const path = `uploads/${Date.now()}_${file.name}`;
                    const { data, error } = await supabase.storage.from('images').upload(path, file);
                    if (error) return alert('ä¸Šä¼ å¤±è´¥');
                    // è·å–å…¬å¼€é“¾æ¥
                    const { data: { publicUrl } } = supabase.storage.from('images').getPublicUrl(path);
                    this.post.blocks[idx].value = publicUrl;
                },
                async publish() {
                    // 1. æ’å…¥ resources
                    const { data: res, error } = await supabase.from('resources').insert({
                        title: this.post.title,
                        content_json: this.post.blocks,
                        category_id: 3 // é»˜è®¤ç»¼è‰ºï¼Œå¯æ‰©å±•
                    }).select().single();
                    
                    if(error) return alert('å‘å¸ƒå¤±è´¥: ' + error.message);

                    // 2. å¤„ç†æ ‡ç­¾ (ç®€åŒ–ç‰ˆï¼šå…ˆæŸ¥åæ’)
                    for (const t of this.post.tags) {
                        // å°è¯•æ’å…¥æ ‡ç­¾(å¦‚æœå­˜åœ¨åˆ™å¿½ç•¥)ï¼Œç„¶åè·å–ID
                        // Supabase æ²¡æœ‰ insert or ignoreï¼Œéœ€è¦ç”¨ select -> insert
                        let { data: tag } = await supabase.from('tags').select('id').eq('name', t.name).eq('type', t.type).single();
                        if (!tag) {
                            const { data: newTag } = await supabase.from('tags').insert(t).select().single();
                            tag = newTag;
                        }
                        // å…³è”
                        await supabase.from('resource_tags').insert({ resource_id: res.id, tag_id: tag.id });
                    }
                    alert('å‘å¸ƒæˆåŠŸ');
                    this.post = { title: '', blocks: [], tags: [] };
                },

                // åˆ—è¡¨é€»è¾‘
                async loadResources() {
                    const { data } = await supabase.from('resources').select('id, title').order('created_at', { ascending: false }).limit(20);
                    this.resources = data || [];
                },
                async deleteResource(id) {
                    if(!confirm('åˆ ?')) return;
                    await supabase.from('resources').delete().eq('id', id);
                    this.loadResources();
                }
            }
        }
    </script>
</body>
</html>
