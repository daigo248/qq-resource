<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸åå°ç®¡ç†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="admin()">
    
    <!-- ç™»å½•ç•Œé¢ -->
    <div x-show="!token" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-xl font-bold mb-4 text-blue-600">è“é²¸ä¸­æ§å°</h1>
            <input type="text" x-model="loginForm.loginId" placeholder="ç®¡ç†å‘˜è´¦å·" class="w-full border p-2 rounded mb-4">
            <input type="password" x-model="loginForm.password" placeholder="å¯†ç " class="w-full border p-2 rounded mb-6">
            <button @click="login" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ç™»å½•</button>
        </div>
    </div>

    <!-- åå°ä¸»ç•Œé¢ -->
    <div x-show="token" class="min-h-screen" x-cloak>
        <nav class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-md">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <span class="font-bold text-lg">ğŸ‹ è“é²¸ç®¡ç†</span>
                <div class="space-x-1 text-sm flex">
                    <button @click="switchTab('post')" :class="tab==='post'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">å‘å¸ƒ/ä¿®æ”¹</button>
                    <button @click="switchTab('list')" :class="tab==='list'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">æ–‡ç« åˆ—è¡¨</button>
                    <button @click="switchTab('users')" :class="tab==='users'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">ç”¨æˆ·ç®¡ç†</button>
                    <button @click="switchTab('cats')" :class="tab==='cats'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">åˆ†ç±»ç®¡ç†</button>
                    <div class="w-px h-6 bg-slate-600 mx-2 self-center"></div>
                    <button @click="logout" class="text-red-400 hover:text-red-300 px-3 py-2">é€€å‡º</button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-6">
            
            <!-- 1. å‘å¸ƒ/ç¼–è¾‘é¡µ -->
            <div x-show="tab === 'post'" class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800" x-text="isEdit ? 'âœï¸ ä¿®æ”¹èµ„æº (ID: '+post.id+')' : 'âœ¨ å‘å¸ƒæ–°èµ„æº'"></h2>
                    <button x-show="isEdit" @click="resetPost()" class="text-sm text-blue-500 hover:underline">å–æ¶ˆä¿®æ”¹ï¼Œè½¬ä¸ºå‘å¸ƒ</button>
                </div>
                
                <div class="space-y-4">
                    <input type="text" x-model="post.title" placeholder="æ ‡é¢˜ (åŒ…å«æ—¥æœŸå¯è‡ªåŠ¨è¯†åˆ«ï¼Œå¦‚ï¼š2025å¹´12æœˆ8æ—¥)" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 outline-none">
                    
                    <div class="flex gap-4">
                        <select x-model="post.category_id" class="border-2 border-gray-200 p-3 rounded-lg flex-1 bg-white">
                            <option value="">é€‰æ‹©åˆ†ç±»...</option>
                            <template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template>
                        </select>
                        <input type="text" x-model="post.manualDate" placeholder="æ‰‹åŠ¨æ—¥æœŸ (å¦‚è‡ªåŠ¨è¯†åˆ«å¤±è´¥å¯å¡«æ­¤é¡¹)" class="border-2 border-gray-200 p-3 rounded-lg flex-1">
                    </div>

                    <!-- å†…å®¹å—ç¼–è¾‘å™¨ -->
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 bg-gray-50 space-y-4">
                        <template x-for="(block, idx) in post.blocks" :key="idx">
                            <div class="flex gap-3 items-start bg-white p-4 rounded-lg shadow-sm border border-gray-200 group">
                                <div class="flex flex-col gap-2 mt-1">
                                    <span class="text-xs font-bold text-gray-400 bg-gray-100 w-6 h-6 flex items-center justify-center rounded-full" x-text="idx+1"></span>
                                    <button @click="post.blocks.splice(idx,1)" class="text-red-400 hover:text-red-600 text-xs">åˆ é™¤</button>
                                </div>
                                
                                <div class="flex-1 space-y-2">
                                    <div class="flex gap-2">
                                        <select x-model="block.type" class="border p-1 rounded text-sm bg-gray-50 font-bold text-gray-600">
                                            <option value="text">æ–‡æœ¬æ®µè½</option>
                                            <option value="link">é“¾æ¥åœ°å€</option>
                                            <option value="image">å›¾ç‰‡</option>
                                        </select>
                                        <label class="flex items-center gap-1 text-xs cursor-pointer select-none px-2 rounded border" :class="block.locked ? 'bg-red-50 border-red-200 text-red-600' : 'bg-green-50 border-green-200 text-green-600'">
                                            <input type="checkbox" x-model="block.locked" class="hidden">
                                            <span x-text="block.locked ? 'ğŸ”’ éœ€è§£é”æŸ¥çœ‹' : 'ğŸ”“ å…è´¹å…¬å¼€'"></span>
                                        </label>
                                    </div>

                                    <textarea x-show="block.type==='text'" x-model="block.value" rows="3" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none" placeholder="è¾“å…¥æ­£æ–‡å†…å®¹..."></textarea>
                                    
                                    <input x-show="block.type==='link'" type="text" x-model="block.value" class="w-full border p-2 rounded text-sm text-blue-600" placeholder="https://example.com/download...">
                                    
                                    <div x-show="block.type==='image'" class="space-y-2">
                                        <div class="flex gap-2">
                                            <input type="file" @change="uploadImg($event, idx)" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                        </div>
                                        <input type="text" x-model="block.value" placeholder="æˆ–ç›´æ¥è¾“å…¥å›¾ç‰‡ URL" class="w-full border p-2 rounded text-sm">
                                        <div x-show="block.value" class="mt-2">
                                            <img :src="block.value" class="h-20 rounded border">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div class="flex gap-3 justify-center pt-2">
                            <button @click="addBlock('text')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">+ ğŸ“ æ–‡æœ¬</button>
                            <button @click="addBlock('link')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">+ ğŸ”— é“¾æ¥ (é»˜è®¤é”)</button>
                            <button @click="addBlock('image')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">+ ğŸ–¼ï¸ å›¾ç‰‡</button>
                        </div>
                    </div>
                    
                    <button @click="publish" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-lg shadow-blue-200 transition">
                        <span x-text="isUploading ? 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...' : (isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'ç«‹å³å‘å¸ƒ')"></span>
                    </button>
                </div>
            </div>

            <!-- 2. æ–‡ç« åˆ—è¡¨é¡µ -->
            <div x-show="tab === 'list'" class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4 text-gray-800">æ–‡ç« ç®¡ç†</h2>
                <div class="flex gap-2 mb-6">
                    <input type="text" x-model="searchQ" @keyup.enter="loadResources" class="border p-2 flex-1 rounded-lg" placeholder="æœç´¢æ ‡é¢˜æˆ–æ—¥æœŸ...">
                    <button @click="loadResources" class="bg-blue-600 text-white px-6 rounded-lg font-bold">æœç´¢</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="p-3 rounded-l-lg">ID</th>
                                <th class="p-3">æ ‡é¢˜</th>
                                <th class="p-3">æ˜¾ç¤ºæ—¥æœŸ</th>
                                <th class="p-3 rounded-r-lg">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <template x-for="r in resourceList" :key="r.id">
                                <tr class="hover:bg-blue-50">
                                    <td class="p-3 font-mono text-gray-500" x-text="r.id"></td>
                                    <td class="p-3 font-bold text-gray-800" x-text="r.title"></td>
                                    <td class="p-3 text-gray-500" x-text="r.custom_date || '-'"></td>
                                    <td class="p-3">
                                        <button @click="editResource(r.id)" class="text-blue-600 hover:text-blue-800 font-bold mr-3">ä¿®æ”¹</button>
                                        <button @click="delResource(r.id)" class="text-red-500 hover:text-red-700">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. ç”¨æˆ·ç®¡ç†é¡µ (ä½ éœ€è¦çš„!) -->
            <div x-show="tab === 'users'" class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">ç”¨æˆ·åˆ—è¡¨ & é…é¢æ§åˆ¶</h2>
                    <button @click="loadUsers" class="text-sm text-blue-500">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="p-3 border-b">ID</th>
                                <th class="p-3 border-b">ç”¨æˆ·å</th>
                                <th class="p-3 border-b">QQé‚®ç®±</th>
                                <th class="p-3 border-b">å½“å‰åŸºç¡€é¢åº¦</th>
                                <th class="p-3 border-b">ä¸´æ—¶è§„åˆ™ (æ—¥æœŸèŒƒå›´)</th>
                                <th class="p-3 border-b">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <template x-for="u in users" :key="u.id">
                                <tr class="hover:bg-yellow-50">
                                    <td class="p-3 font-mono text-gray-400" x-text="u.id"></td>
                                    <td class="p-3 font-bold" x-text="u.username"></td>
                                    <td class="p-3" x-text="u.email"></td>
                                    <td class="p-3">
                                        <span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold" x-text="(u.daily_limit || 1) + ' æ¬¡/å¤©'"></span>
                                    </td>
                                    <td class="p-3">
                                        <div x-show="u.temp_quota_config" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded border border-red-200">
                                            <span x-text="formatQuota(u.temp_quota_config)"></span>
                                        </div>
                                        <div x-show="!u.temp_quota_config" class="text-gray-300 text-xs">-</div>
                                    </td>
                                    <td class="p-3">
                                        <button @click="editQuota(u)" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">è®¾ç½®é™é¢</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. åˆ†ç±»ç®¡ç†é¡µ -->
            <div x-show="tab === 'cats'" class="bg-white p-6 rounded-lg shadow max-w-lg">
                <h2 class="text-xl font-bold mb-4">åˆ†ç±»ç®¡ç†</h2>
                <div class="flex gap-2 mb-6">
                    <input type="text" x-model="newCat" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°..." class="border p-2 rounded-lg flex-1 outline-none focus:border-blue-500">
                    <button @click="manageCat('add')" class="bg-green-500 text-white px-4 rounded-lg font-bold hover:bg-green-600">æ·»åŠ </button>
                </div>
                <div class="space-y-2">
                    <template x-for="c in categories" :key="c.id">
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border">
                            <span class="font-bold text-gray-700" x-text="c.name"></span>
                            <button @click="manageCat('del', c.id)" class="text-red-500 text-xs hover:bg-red-100 px-2 py-1 rounded">åˆ é™¤</button>
                        </div>
                    </template>
                </div>
            </div>

        </main>
    </div>

    <script>
        function admin() {
            return {
                token: localStorage.getItem('adm_token') || '',
                tab: 'post', // 'post', 'list', 'users', 'cats'
                isEdit: false,
                isUploading: false,
                loginForm: { loginId: '', password: '' },
                
                categories: [], 
                resourceList: [], 
                users: [],
                searchQ: '',
                
                post: { id: null, title: '', category_id: '', blocks: [], manualDate: '' },
                newCat: '',

                async init() { 
                    if(this.token) { 
                        this.loadCats(); 
                        this.loadResources(); 
                        // é¢„åŠ è½½ users ä»¥é˜² tab åˆ‡æ¢å¡é¡¿
                        // this.loadUsers(); 
                    } 
                },

                // === åŸºç¡€åŠŸèƒ½ ===
                async login() {
                    const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.loginForm, isAdmin:true})});
                    const data = await res.json();
                    if(res.ok) { 
                        this.token = data.token; 
                        localStorage.setItem('adm_token', data.token); 
                        this.loadCats(); 
                        this.loadResources();
                    } else alert(data.error);
                },
                logout() { this.token=''; localStorage.removeItem('adm_token'); location.reload(); },
                auth() { return {'Authorization': `Bearer ${this.token}`}; },
                switchTab(t) { 
                    this.tab = t; 
                    if(t === 'post' && !this.isEdit) this.resetPost();
                    if(t === 'list') this.loadResources();
                    if(t === 'users') this.loadUsers();
                    if(t === 'cats') this.loadCats();
                },

                // === èµ„æºç®¡ç† ===
                async loadCats() { this.categories = (await (await fetch('/api/public/home')).json()).categories; },
                
                async loadResources() {
                    const res = await fetch(`/api/admin/resources?q=${this.searchQ}`, {headers:this.auth()});
                    this.resourceList = await res.json();
                },

                async editResource(id) {
                    const res = await fetch(`/api/admin/resource/${id}`, {headers:this.auth()});
                    const data = await res.json();
                    this.post = { 
                        id: data.id, 
                        title: data.title, 
                        category_id: data.category_id, 
                        blocks: JSON.parse(data.content_json || '[]'), 
                        manualDate: data.custom_date 
                    };
                    this.isEdit = true;
                    this.tab = 'post';
                },

                async delResource(id) {
                    if(!confirm('ç¡®å®šåˆ é™¤? æ­¤æ“ä½œä¸å¯æ¢å¤!')) return;
                    await fetch('/api/admin/resource/delete', {method:'POST', headers:this.auth(), body:JSON.stringify({id})});
                    this.loadResources();
                },

                async publish() {
                    if(!this.post.title) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
                    if(this.post.blocks.length === 0) return alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå†…å®¹å—');
                    
                    const res = await fetch('/api/admin/resource', {method:'POST', headers:this.auth(), body:JSON.stringify(this.post)});
                    if(res.ok) { 
                        alert(this.isEdit ? 'ä¿®æ”¹æˆåŠŸ' : 'å‘å¸ƒæˆåŠŸ'); 
                        this.switchTab('list');
                        this.resetPost();
                    } else alert('æ“ä½œå¤±è´¥');
                },

                // === å†…å®¹å—ä¸ä¸Šä¼  ===
                addBlock(type) {
                    this.post.blocks.push({ 
                        type, 
                        value: '', 
                        locked: type === 'link' // é“¾æ¥é»˜è®¤é”ï¼Œå…¶ä»–é»˜è®¤å¼€
                    });
                },
                resetPost() {
                    this.post = { id: null, title: '', category_id: '', blocks: [], manualDate: '' };
                    this.isEdit = false;
                },
                async uploadImg(e, idx) {
                    const file = e.target.files[0]; if(!file) return;
                    this.isUploading = true;
                    const fd = new FormData(); fd.append('file', file);
                    try {
                        const res = await fetch('/api/admin/upload', {method:'POST', headers:this.auth(), body:fd});
                        const data = await res.json(); 
                        if(data.url) this.post.blocks[idx].value = data.url;
                        else alert('ä¸Šä¼ å¤±è´¥');
                    } catch(e) { alert('ä¸Šä¼ å‡ºé”™'); }
                    this.isUploading = false;
                },

                // === ç”¨æˆ·ç®¡ç† (ä¿®å¤å) ===
                async loadUsers() {
                    const res = await fetch('/api/admin/users', { headers:this.auth() });
                    if(res.ok) this.users = await res.json();
                },
                
                formatQuota(jsonStr) {
                    try { 
                        const o = JSON.parse(jsonStr); 
                        if(!o) return '';
                        return `${o.start} è‡³ ${o.end} : æ¯æ—¥${o.limit}æ¬¡`; 
                    } catch(e){return 'é…ç½®é”™è¯¯';}
                },

                async editQuota(u) {
                    const limit = prompt(`ä¸ºç”¨æˆ· ${u.username} è®¾ç½®ä¸´æ—¶æ¯æ—¥æ¬¡æ•° (ä¾‹å¦‚ 20):`, 20);
                    if(!limit) return;
                    
                    const today = new Date().toISOString().split('T')[0];
                    const start = prompt('å¼€å§‹æ—¥æœŸ (YYYY-MM-DD):', today);
                    if(!start) return;
                    
                    const nextDay = new Date(Date.now() + 86400000 * 2).toISOString().split('T')[0];
                    const end = prompt('ç»“æŸæ—¥æœŸ (YYYY-MM-DD):', nextDay);
                    if(!end) return;

                    const config = { start, end, limit: parseInt(limit) };
                    const res = await fetch('/api/admin/user/quota', { 
                        method:'POST', 
                        headers:this.auth(), 
                        body:JSON.stringify({ userId:u.id, config }) 
                    });
                    
                    if(res.ok) {
                        alert('è®¾ç½®æˆåŠŸ');
                        this.loadUsers();
                    } else alert('è®¾ç½®å¤±è´¥');
                },

                // === åˆ†ç±»ç®¡ç† ===
                async manageCat(action, id) {
                    if(action==='add' && !this.newCat) return;
                    if(action==='del' && !confirm('ç¡®å®šåˆ é™¤è¯¥åˆ†ç±»å—?')) return;
                    await fetch('/api/admin/category', { method:'POST', headers:this.auth(), body:JSON.stringify({action, name:this.newCat, id})});
                    this.newCat = ''; this.loadCats();
                }
            }
        }
    </script>
</body>
</html>
