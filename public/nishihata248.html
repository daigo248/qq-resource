<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è“é²¸åå°ç®¡ç†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="admin()">
    
    <!-- ç™»å½•ç•Œé¢ -->
    <div x-show="!token" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-xl font-bold mb-4 text-blue-600">è“é²¸ä¸­æ§å°</h1>
            <input type="text" x-model="loginForm.loginId" placeholder="ç®¡ç†å‘˜è´¦å·" class="w-full border p-2 rounded mb-4">
            <input type="password" x-model="loginForm.password" placeholder="å¯†ç " class="w-full border p-2 rounded mb-6">
            <button @click="login" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ç™»å½•</button>
        </div>
    </div>

    <!-- åå°ä¸»ç•Œé¢ -->
    <div x-show="token" class="min-h-screen" x-cloak>
        <nav class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-md">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <span class="font-bold text-lg">ğŸ‹ è“é²¸ç®¡ç†</span>
                <div class="space-x-1 text-sm flex">
                    <button @click="switchTab('post')" :class="tab==='post'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">å‘å¸ƒ/ä¿®æ”¹</button>
                    <button @click="switchTab('list')" :class="tab==='list'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">æ–‡ç« åˆ—è¡¨</button>
                    <button @click="switchTab('users')" :class="tab==='users'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">ç”¨æˆ·ç®¡ç†</button>
                    <button @click="switchTab('msgs')" :class="tab==='msgs'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">ç§ä¿¡ç®¡ç†</button>
                    <button @click="switchTab('cats')" :class="tab==='cats'?'bg-slate-700 text-white':'text-slate-300 hover:text-white'" class="px-3 py-2 rounded transition">åˆ†ç±»ç®¡ç†</button>
                    <div class="w-px h-6 bg-slate-600 mx-2 self-center"></div>
                    <button @click="logout" class="text-red-400 hover:text-red-300 px-3 py-2">é€€å‡º</button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto p-6">
            
            <!-- 1. å‘å¸ƒ/ç¼–è¾‘é¡µ -->
            <div x-show="tab === 'post'" class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800" x-text="isEdit ? 'âœï¸ ä¿®æ”¹èµ„æº (ID: '+post.id+')' : 'âœ¨ å‘å¸ƒæ–°èµ„æº'"></h2>
                    <button x-show="isEdit" @click="resetPost()" class="text-sm text-blue-500 hover:underline">å–æ¶ˆä¿®æ”¹ï¼Œè½¬ä¸ºå‘å¸ƒ</button>
                </div>
                <div class="space-y-4">
                    <input type="text" x-model="post.title" placeholder="æ ‡é¢˜ (åŒ…å«æ—¥æœŸå¯è‡ªåŠ¨è¯†åˆ«)" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-blue-500 outline-none">
                    <div class="flex gap-4">
                        <select x-model="post.category_id" class="border-2 border-gray-200 p-3 rounded-lg flex-1 bg-white">
                            <option value="">é€‰æ‹©åˆ†ç±»...</option>
                            <template x-for="c in categories" :key="c.id"><option :value="c.id" x-text="c.name"></option></template>
                        </select>
                        <input type="text" x-model="post.manualDate" placeholder="æ‰‹åŠ¨æ—¥æœŸ (å¯é€‰)" class="border-2 border-gray-200 p-3 rounded-lg flex-1">
                    </div>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 bg-gray-50 space-y-4">
                        <template x-for="(block, idx) in post.blocks" :key="idx">
                            <div class="flex gap-3 items-start bg-white p-4 rounded-lg shadow-sm border border-gray-200 group">
                                <div class="flex flex-col gap-2 mt-1">
                                    <span class="text-xs font-bold text-gray-400 bg-gray-100 w-6 h-6 flex items-center justify-center rounded-full" x-text="idx+1"></span>
                                    <button @click="post.blocks.splice(idx,1)" class="text-red-400 hover:text-red-600 text-xs">åˆ é™¤</button>
                                </div>
                                <div class="flex-1 space-y-2">
                                    <div class="flex gap-2">
                                        <select x-model="block.type" class="border p-1 rounded text-sm bg-gray-50 font-bold text-gray-600">
                                            <option value="text">æ–‡æœ¬æ®µè½</option><option value="link">é“¾æ¥åœ°å€</option><option value="image">å›¾ç‰‡</option>
                                        </select>
                                        <label class="flex items-center gap-1 text-xs cursor-pointer select-none px-2 rounded border" :class="block.locked ? 'bg-red-50 border-red-200 text-red-600' : 'bg-green-50 border-green-200 text-green-600'">
                                            <input type="checkbox" x-model="block.locked" class="hidden">
                                            <span x-text="block.locked ? 'ğŸ”’ éœ€è§£é”' : 'ğŸ”“ å…¬å¼€'"></span>
                                        </label>
                                    </div>
                                    <textarea x-show="block.type==='text'" x-model="block.value" rows="3" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none"></textarea>
                                    <input x-show="block.type==='link'" type="text" x-model="block.value" class="w-full border p-2 rounded text-sm text-blue-600">
                                    <div x-show="block.type==='image'" class="space-y-2">
                                        <div class="flex gap-2"><input type="file" @change="uploadImg($event, idx)" class="text-sm"></div>
                                        <input type="text" x-model="block.value" placeholder="å›¾ç‰‡ URL" class="w-full border p-2 rounded text-sm">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div class="flex gap-3 justify-center pt-2">
                            <button @click="addBlock('text')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">+ æ–‡æœ¬</button>
                            <button @click="addBlock('link')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">+ é“¾æ¥</button>
                            <button @click="addBlock('image')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50">+ å›¾ç‰‡</button>
                        </div>
                    </div>
                    <button @click="publish" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-lg shadow-blue-200 transition">
                        <span x-text="isUploading ? 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...' : (isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'ç«‹å³å‘å¸ƒ')"></span>
                    </button>
                </div>
            </div>

            <!-- 2. æ–‡ç« åˆ—è¡¨é¡µ -->
            <div x-show="tab === 'list'" class="bg-white p-6 rounded-lg shadow">
                <div class="flex gap-2 mb-6">
                    <input type="text" x-model="searchQ" @keyup.enter="loadResources" class="border p-2 flex-1 rounded-lg" placeholder="æœç´¢æ ‡é¢˜æˆ–æ—¥æœŸ...">
                    <button @click="loadResources" class="bg-blue-600 text-white px-6 rounded-lg font-bold">æœç´¢</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600"><tr><th class="p-3">ID</th><th class="p-3">æ ‡é¢˜</th><th class="p-3">æ—¥æœŸ</th><th class="p-3">æ“ä½œ</th></tr></thead>
                    <tbody class="divide-y"><template x-for="r in resourceList" :key="r.id"><tr class="hover:bg-blue-50"><td class="p-3" x-text="r.id"></td><td class="p-3 font-bold" x-text="r.title"></td><td class="p-3" x-text="r.custom_date"></td><td class="p-3"><button @click="editResource(r.id)" class="text-blue-600 mr-2">ä¿®æ”¹</button><button @click="delResource(r.id)" class="text-red-500">åˆ é™¤</button></td></tr></template></tbody></table>
                </div>
            </div>

            <!-- 3. ç”¨æˆ·ç®¡ç†é¡µ -->
            <div x-show="tab === 'users'" class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">ç”¨æˆ·ç®¡ç†</h2><button @click="loadUsers" class="text-sm text-blue-500">åˆ·æ–°</button></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse"><thead class="bg-gray-50 text-gray-600"><tr><th class="p-3 border-b">ID</th><th class="p-3 border-b">ç”¨æˆ·</th><th class="p-3 border-b">é‚®ç®±</th><th class="p-3 border-b">é¢åº¦</th><th class="p-3 border-b">æ“ä½œ</th></tr></thead>
                    <tbody class="divide-y"><template x-for="u in users" :key="u.id"><tr class="hover:bg-yellow-50"><td class="p-3" x-text="u.id"></td><td class="p-3" x-text="u.username"></td><td class="p-3" x-text="u.email"></td><td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded" x-text="(u.daily_limit||1)+'æ¬¡/å¤©'"></span></td><td class="p-3"><button @click="editQuota(u)" class="text-blue-600">è®¾ç½®é™é¢</button></td></tr></template></tbody></table>
                </div>
            </div>

            <!-- 4. ç§ä¿¡ç®¡ç†é¡µ (æ–°) -->
            <div x-show="tab === 'msgs'" class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">ç”¨æˆ·ç§ä¿¡åˆ—è¡¨</h2><button @click="loadMsgs" class="text-sm text-blue-500">åˆ·æ–°</button></div>
                <div class="space-y-4">
                    <template x-for="m in messages" :key="m.id">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-bold text-blue-600" x-text="m.username"></span>
                                    <span class="text-xs text-gray-400 ml-2" x-text="m.email"></span>
                                </div>
                                <span class="text-xs text-gray-400" x-text="new Date(m.created_at).toLocaleString()"></span>
                            </div>
                            <p class="text-gray-700 whitespace-pre-wrap" x-text="m.content"></p>
                        </div>
                    </template>
                    <div x-show="messages.length === 0" class="text-center text-gray-400 py-4">æš‚æ— ç§ä¿¡</div>
                </div>
            </div>

            <!-- 5. åˆ†ç±»ç®¡ç†é¡µ -->
            <div x-show="tab === 'cats'" class="bg-white p-6 rounded-lg shadow max-w-lg">
                <h2 class="text-xl font-bold mb-4">åˆ†ç±»ç®¡ç†</h2>
                <div class="flex gap-2 mb-6"><input type="text" x-model="newCat" placeholder="æ–°åˆ†ç±»" class="border p-2 rounded flex-1"><button @click="manageCat('add')" class="bg-green-500 text-white px-4 rounded">æ·»åŠ </button></div>
                <div class="space-y-2"><template x-for="c in categories" :key="c.id"><div class="flex justify-between items-center bg-gray-50 p-3 rounded border"><span x-text="c.name"></span><button @click="manageCat('del', c.id)" class="text-red-500 text-xs">åˆ é™¤</button></div></template></div>
            </div>

        </main>
    </div>

    <script>
        function admin() {
            return {
                token: localStorage.getItem('adm_token') || '', tab: 'post', isEdit: false, isUploading: false,
                loginForm: { loginId: '', password: '' },
                categories: [], resourceList: [], users: [], messages: [], searchQ: '',
                post: { id: null, title: '', category_id: '', blocks: [], manualDate: '' }, newCat: '',

                async init() { if(this.token) { this.loadCats(); this.loadResources(); } },
                async login() {
                    const res = await fetch('/api/auth/login', {method:'POST', body:JSON.stringify({...this.loginForm, isAdmin:true})});
                    const data = await res.json(); if(res.ok) { this.token = data.token; localStorage.setItem('adm_token', data.token); this.loadCats(); this.loadResources(); } else alert(data.error);
                },
                logout() { this.token=''; localStorage.removeItem('adm_token'); location.reload(); },
                auth() { return {'Authorization': `Bearer ${this.token}`}; },
                switchTab(t) { 
                    this.tab = t; 
                    if(t === 'post' && !this.isEdit) this.resetPost();
                    if(t === 'list') this.loadResources();
                    if(t === 'users') this.loadUsers();
                    if(t === 'msgs') this.loadMsgs();
                    if(t === 'cats') this.loadCats();
                },

                // èµ„æºé€»è¾‘ (ç•¥å¾®ç®€å†™)
                async loadCats() { this.categories = (await (await fetch('/api/public/home')).json()).categories; },
                async loadResources() { const res = await fetch(`/api/admin/resources?q=${this.searchQ}`, {headers:this.auth()}); this.resourceList = await res.json(); },
                async editResource(id) {
                    const res = await fetch(`/api/admin/resource/${id}`, {headers:this.auth()}); const data = await res.json();
                    this.post = { id: data.id, title: data.title, category_id: data.category_id, blocks: JSON.parse(data.content_json || '[]'), manualDate: data.custom_date };
                    this.isEdit = true; this.tab = 'post';
                },
                async delResource(id) { if(!confirm('åˆ é™¤?')) return; await fetch('/api/admin/resource/delete', {method:'POST', headers:this.auth(), body:JSON.stringify({id})}); this.loadResources(); },
                async publish() {
                    if(!this.post.title || this.post.blocks.length===0) return alert('è¯·å¡«å†™å®Œæ•´');
                    const res = await fetch('/api/admin/resource', {method:'POST', headers:this.auth(), body:JSON.stringify(this.post)});
                    if(res.ok) { alert('æˆåŠŸ'); this.switchTab('list'); this.resetPost(); } else alert('å¤±è´¥');
                },
                addBlock(type) { this.post.blocks.push({ type, value: '', locked: type === 'link' }); },
                resetPost() { this.post = { id: null, title: '', category_id: '', blocks: [], manualDate: '' }; this.isEdit = false; },
                async uploadImg(e, idx) {
                    const file = e.target.files[0]; if(!file) return; this.isUploading = true; const fd = new FormData(); fd.append('file', file);
                    try { const res = await fetch('/api/admin/upload', {method:'POST', headers:this.auth(), body:fd}); const data = await res.json(); if(data.url) this.post.blocks[idx].value = data.url; } catch(e){} this.isUploading = false;
                },

                // ç”¨æˆ·ç®¡ç†
                async loadUsers() { const res = await fetch('/api/admin/users', { headers:this.auth() }); if(res.ok) this.users = await res.json(); },
                async editQuota(u) {
                    const limit = prompt(`ä¸º ${u.username} è®¾ç½®ä¸´æ—¶æ¯æ—¥æ¬¡æ•°:`, 20); if(!limit) return;
                    const today = new Date().toISOString().split('T')[0];
                    const start = prompt('å¼€å§‹æ—¥æœŸ:', today); const end = prompt('ç»“æŸæ—¥æœŸ:', today);
                    if(start && end) { await fetch('/api/admin/user/quota', { method:'POST', headers:this.auth(), body:JSON.stringify({ userId:u.id, config:{start, end, limit:parseInt(limit)} }) }); this.loadUsers(); }
                },

                // ç§ä¿¡ç®¡ç† (æ–°)
                async loadMsgs() { const res = await fetch('/api/admin/messages', { headers:this.auth() }); if(res.ok) this.messages = await res.json(); },

                // åˆ†ç±»
                async manageCat(action, id) { if(action==='add'&&!this.newCat) return; await fetch('/api/admin/category', { method:'POST', headers:this.auth(), body:JSON.stringify({action, name:this.newCat, id})}); this.newCat=''; this.loadCats(); }
            }
        }
    </script>
</body>
</html>
